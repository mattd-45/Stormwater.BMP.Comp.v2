<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Stormwater BMP Comparison Tool</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease, box-shadow 0.2s ease; }
    body { font-family: 'Open Sans', 'Calibri', sans-serif; background: linear-gradient(to bottom, #f1f5f9 0%, #f8fafc 100%); min-height: 100vh; margin: 0; color: #0f172a; }
    
    .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    
    .glass { background: linear-gradient(to bottom, #ffffff, #f8fafc); border: 1px solid #e2e8f0; box-shadow: 0 2px 8px 0 rgba(0, 0, 0, 0.08), 0 1px 3px 0 rgba(0, 0, 0, 0.05); }
    .glass:hover { box-shadow: 0 8px 16px -4px rgba(0, 0, 0, 0.12), 0 4px 8px -2px rgba(0, 0, 0, 0.08); transition: box-shadow 0.2s ease-in-out; }
    .glass-dark { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); color: white; border: 1px solid #334155; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.15), 0 2px 4px -1px rgba(0, 0, 0, 0.1); }
    
    @media print {
      body { background: white; color: black; }
      aside, header button, .no-print { display: none !important; }
      main { overflow: visible !important; height: auto !important; }
      .glass, .glass-dark { box-shadow: none !important; border: 1px solid #ccc !important; color: black !important; background: white !important; }
      .glass-dark h2, .glass-dark h4, .glass-dark div { color: black !important; }
      input { border: none !important; background: transparent !important; color: black !important; }
      /* Override all dark backgrounds for print */
      .bg-slate-800, .bg-slate-800\/50, .bg-slate-800\/30, .bg-slate-900, .bg-slate-900\/30, .bg-slate-700, .bg-slate-700\/50 { background: #f8f9fa !important; }
      .bg-emerald-900\/20, .bg-amber-900\/20 { background: #f0f0f0 !important; }
      .bg-red-900\/30, .bg-red-900\/20 { background: #fef2f2 !important; }
      /* Override dark text colors for print - use dark colors for readability */
      .text-white, .text-slate-200, .text-slate-300 { color: #1f2937 !important; }
      .text-slate-400, .text-slate-500 { color: #4b5563 !important; }
      .text-indigo-300, .text-indigo-400 { color: #1f2937 !important; }
      .text-emerald-400 { color: #065f46 !important; font-weight: bold !important; }
      .text-sky-400 { color: #075985 !important; font-weight: bold !important; }
      .text-indigo-600 { color: #312e81 !important; font-weight: bold !important; }
      .text-red-300, .text-red-400 { color: #991b1b !important; font-weight: bold !important; }
      .text-amber-400 { color: #92400e !important; font-weight: bold !important; }
      /* Borders for print */
      .border-slate-700, .border-slate-700\/50 { border-color: #d1d5db !important; }
      .border-indigo-500\/30 { border-color: #d1d5db !important; }
      .border-emerald-500\/30, .border-amber-500\/30 { border-color: #9ca3af !important; }
      canvas { max-width: 100% !important; }
      .overflow-y-auto { overflow: visible !important; height: auto !important; }
      .overflow-hidden { overflow: visible !important; }
      #detail-panel .overflow-y-auto { overflow: visible !important; height: auto !important; max-height: none !important; }
      .grid { display: block !important; }
      .grid > div { margin-bottom: 10px; page-break-inside: auto; }
      #print-header { display: block !important; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 10px; position: relative !important; }
      #print-header img { display: block !important; visibility: visible !important; max-height: 48px !important; width: auto !important; }
      /* Footer at end of content - force to bottom */
      main { display: flex !important; flex-direction: column !important; }
      main > div:last-of-type { flex: 1 !important; }
      #print-footer { display: block !important; position: relative !important; margin-top: 10px !important; margin-bottom: 0 !important; border-top: 2px solid #ccc !important; padding: 8px 20px !important; font-size: 10px !important; text-align: center !important; width: 100% !important; box-sizing: border-box !important; background: white !important; page-break-inside: avoid !important; page-break-before: auto !important; }
      #print-footer a { word-break: break-all !important; overflow-wrap: anywhere !important; max-width: 100% !important; display: inline !important; font-family: monospace !important; font-size: 9px !important; line-height: 1.4 !important; }
      #print-link-container { max-width: 100% !important; overflow: hidden !important; word-break: break-all !important; overflow-wrap: anywhere !important; width: 100% !important; box-sizing: border-box !important; }
      main { padding-bottom: 20px !important; }
      /* Ensure footer doesn't appear in middle - hide until end */
      .max-w-7xl ~ #print-footer { display: none !important; }
      main > #print-footer:last-child { display: block !important; }
      /* Lighten table row backgrounds for print */
      tr { background: white !important; }
      tr.bg-indigo-50\/80, tr.bg-slate-50, tr:hover { background: #f9fafb !important; }
      tbody tr:nth-child(even) { background: #f9fafb !important; }
      tbody tr:nth-child(odd) { background: white !important; }
      /* Condense table rows for print - reduce padding and spacing */
      table { font-size: 9px !important; }
      table th, table td { padding: 2px 4px !important; line-height: 1.2 !important; }
      table th { font-size: 8px !important; padding: 3px 4px !important; }
      table td { font-size: 9px !important; }
      table input { font-size: 8px !important; padding: 1px 2px !important; height: auto !important; }
      table .text-xs { font-size: 9px !important; }
      table .text-sm { font-size: 10px !important; }
      tbody tr { height: auto !important; min-height: 0 !important; }
      details { display: block !important; page-break-inside: auto !important; margin-bottom: 8px !important; }
      details[open] summary { margin-bottom: 8px !important; border-bottom: 1px solid #ccc !important; padding-bottom: 5px !important; }
      details summary { display: block !important; list-style: none !important; font-weight: bold !important; cursor: default !important; font-size: 11px !important; }
      details summary::-webkit-details-marker { display: none !important; }
      details summary::marker { display: none !important; }
      details > div { display: block !important; }
      details label { font-size: 8px !important; }
      #detail-panel { display: block !important; background: white !important; color: black !important; border: 1px solid #ccc !important; position: relative !important; visibility: visible !important; opacity: 1 !important; height: auto !important; max-height: none !important; overflow: visible !important; page-break-inside: auto !important; page-break-before: always !important; page-break-after: auto !important; }
      #detail-panel * { color: #1f2937 !important; }
      #detail-panel input { border: 1px solid #ccc !important; background: white !important; color: #1f2937 !important; font-size: 8px !important; padding: 2px 4px !important; }
      #detail-panel details label { font-size: 7px !important; }
      #detail-panel details input { font-size: 8px !important; padding: 1px 3px !important; width: 50px !important; }
      #detail-panel details div { font-size: 8px !important; line-height: 1.2 !important; }
      #detail-panel button { display: none !important; }
      /* Ensure all nested dark elements are light in print */
      #detail-panel div, #detail-panel span, #detail-panel label, #detail-panel h2, #detail-panel h3 { color: #1f2937 !important; }
      #detail-panel .bg-slate-800, #detail-panel .bg-slate-800\/50, #detail-panel .bg-slate-800\/30, #detail-panel .bg-slate-900\/30 { background: #f8f9fa !important; }
      /* Force details open in detail panel for print */
      #detail-panel details { display: block !important; }
      #detail-panel details[open] { display: block !important; }
      #detail-panel details:not([open]) { display: block !important; }
      #detail-panel details summary { display: block !important; list-style: none !important; font-weight: bold !important; margin-bottom: 8px !important; padding-bottom: 4px !important; border-bottom: 1px solid #ccc !important; cursor: default !important; }
      #detail-panel details summary::-webkit-details-marker { display: none !important; }
      #detail-panel details summary::marker { display: none !important; }
      #detail-panel details > div { display: block !important; visibility: visible !important; opacity: 1 !important; }
      #detail-panel details div { display: block !important; visibility: visible !important; opacity: 1 !important; }
      #detail-panel details input, #detail-panel details label, #detail-panel details span { display: block !important; visibility: visible !important; opacity: 1 !important; }
      #detail-panel .space-y-4, #detail-panel .space-y-6 { display: block !important; }
      /* Display combined strategy BMP sections in 2 columns for print (after full-width title and Targets Met box) */
      #detail-panel .space-y-6 > .space-y-4 { display: grid !important; grid-template-columns: repeat(2, 1fr) !important; gap: 6px 8px !important; column-gap: 8px !important; }
      #detail-panel .space-y-6 > .space-y-4 > * { display: block !important; margin-bottom: 0 !important; page-break-inside: auto !important; page-break-before: auto !important; break-inside: avoid !important; }
      #detail-panel .space-y-6 > *:not(.space-y-4) { display: block !important; margin-bottom: 6px !important; page-break-inside: auto !important; page-break-before: auto !important; width: 100% !important; }
      /* Condense detail panel sections for print */
      #detail-panel > div { padding: 6px !important; margin-bottom: 6px !important; }
      #detail-panel .p-4, #detail-panel .p-5 { padding: 4px 6px !important; }
      #detail-panel .rounded-lg { border-radius: 4px !important; }
      #detail-panel .border { border-width: 1px !important; }
      /* Condense "Targets Met" box */
      #detail-panel .text-5xl { font-size: 20px !important; line-height: 1 !important; margin-right: 6px !important; }
      #detail-panel .text-lg { font-size: 11px !important; line-height: 1.2 !important; }
      #detail-panel .grid.grid-cols-2 { gap: 6px !important; margin-top: 4px !important; }
      #detail-panel .mb-3 { margin-bottom: 3px !important; }
      #detail-panel .gap-3 { gap: 6px !important; }
      /* Condense Advanced Specs sections */
      #detail-panel details { margin-bottom: 4px !important; page-break-inside: auto !important; page-break-before: auto !important; }
      #detail-panel details summary { margin-bottom: 2px !important; padding-bottom: 1px !important; font-size: 8px !important; line-height: 1.2 !important; }
      #detail-panel details > div { padding: 3px !important; margin-top: 2px !important; }
      #detail-panel .bg-slate-50, #detail-panel .bg-slate-800\/30 { padding: 3px !important; }
      #detail-panel .flex.justify-between { margin-bottom: 1px !important; padding: 0.5px 0 !important; font-size: 8px !important; line-height: 1.3 !important; }
      #detail-panel .border-b { border-bottom-width: 1px !important; padding-bottom: 1px !important; margin-bottom: 1px !important; }
      /* Condense BMP strategy boxes */
      #detail-panel .bg-slate-800\/30 { padding: 4px !important; margin-bottom: 0 !important; }
      /* Ensure BMP boxes fit in 2-column layout */
      #detail-panel .bg-slate-800\/30 > div { padding: 3px !important; }
      #detail-panel .rounded-lg.border { min-height: auto !important; }
      #detail-panel .p-3 { padding: 3px 4px !important; }
      #detail-panel .text-sm { font-size: 9px !important; }
      #detail-panel .text-\[10px\] { font-size: 7px !important; }
      /* Reduce spacing in flex containers */
      #detail-panel .flex { gap: 4px !important; }
      #detail-panel .items-center { align-items: center !important; }
      /* Allow detail panel content to flow across pages */
      #detail-panel > div { page-break-inside: auto !important; }
      #detail-panel .flex-1 { flex: none !important; height: auto !important; max-height: none !important; }
      /* Show images in print */
      #detail-panel .print-image-container { display: block !important; visibility: visible !important; page-break-inside: auto !important; margin-bottom: 6px !important; }
      #detail-panel .print-image-container img { display: block !important; visibility: visible !important; max-width: 300px !important; max-height: 300px !important; border: 1px solid #ccc !important; }
      .xl\:grid-cols-3 { display: block !important; }
      .xl\:col-span-2, .xl\:col-span-1 { width: 100% !important; display: block !important; margin-bottom: 10px !important; }
      /* Reduce spacing around table for print */
      .glass { padding: 5px !important; margin-bottom: 10px !important; }
      .glass > div { padding: 3px !important; }
      .glass h3 { margin-bottom: 5px !important; padding: 3px !important; font-size: 11px !important; }
      table { margin: 0 !important; }
      /* Condense metrics boxes for print - display in single row with reduced padding */
      #metrics-container { display: grid !important; grid-template-columns: repeat(5, 1fr) !important; gap: 5px !important; margin-bottom: 10px !important; }
      #metrics-container > div { padding: 4px 6px !important; margin: 0 !important; border: 1px solid #ccc !important; }
      #metrics-container .text-\[10px\] { font-size: 7px !important; line-height: 1.2 !important; margin-bottom: 2px !important; }
      #metrics-container .text-xl { font-size: 11px !important; line-height: 1.2 !important; }
      #metrics-container .text-xs { font-size: 7px !important; }
      /* Remove all height restrictions for detail panel in print */
      .max-h-\[calc\(100vh-300px\)\] { max-height: none !important; height: auto !important; }
      .flex-col { display: block !important; }
      #detail-panel.flex-col { display: block !important; }
    }
    
    .animate-fade-in { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* Icons */
    .icon-alert::after { content: '!'; font-weight: bold; font-family: monospace; }
    .icon-menu::after { content: '‚ò∞'; }
    .icon-close::after { content: '‚úï'; }
    
    .toggle-checkbox:checked { right: 0; border-color: #68D391; }
    .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }
    
    /* Tooltip styles */
    .tooltip-container { position: relative; display: inline-block; }
    .tooltip-text { visibility: hidden; opacity: 0; position: absolute; z-index: 1000; background-color: #1e293b; color: white; text-align: left; padding: 10px 12px; border-radius: 6px; font-size: 11px; line-height: 1.5; width: 280px; bottom: 125%; left: 50%; margin-left: -140px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); transition: opacity 0.3s, visibility 0.3s; pointer-events: none; }
    .tooltip-text::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #1e293b transparent transparent transparent; }
    .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }
    
    /* Hide strategy images on screen - only show in print */
    #detail-panel .print-image-container { display: none !important; }
    
    /* Image hover tooltip */
    .image-tooltip-container { position: relative; display: inline-block; cursor: help; }
    .image-tooltip { visibility: hidden; opacity: 0; position: fixed; z-index: 1001; background-color: white; border: 2px solid #6366f1; border-radius: 8px; padding: 8px; box-shadow: 0 8px 16px rgba(0,0,0,0.3); transition: opacity 0.2s, visibility 0.2s; pointer-events: none; max-width: 600px; }
    .image-tooltip img { max-width: 560px; max-height: 560px; display: block; border-radius: 4px; }
    .image-tooltip::after { display: none; }
    .image-tooltip.show { visibility: visible !important; opacity: 1 !important; }
    /* Ensure tooltip appears above dark backgrounds */
    .glass-dark .image-tooltip { z-index: 1002; }
    
    /* Lever Control Styles */
    .lever-container { position: relative; display: inline-block; }
    .lever-control { 
      position: fixed; 
      z-index: 1003; 
      visibility: hidden;
      opacity: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      min-width: 200px;
      text-align: center;
      transition: opacity 0.2s, visibility 0.2s;
      pointer-events: auto;
    }
    .lever-control.show { visibility: visible; }
    .lever-track {
      width: 180px;
      height: 40px;
      background: rgba(255,255,255,0.2);
      border-radius: 20px;
      position: relative;
      margin: 15px auto;
      border: 2px solid rgba(255,255,255,0.3);
    }
    .lever-handle {
      width: 50px;
      height: 50px;
      background: white;
      border-radius: 50%;
      position: absolute;
      top: -7px;
      left: 0;
      cursor: grab;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      transition: transform 0.1s;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }
    .lever-handle:active { cursor: grabbing; transform: scale(0.95); }
    .lever-handle::before {
      content: '‚öô';
      font-size: 24px;
    }
    .lever-value {
      color: white;
      font-size: 18px;
      font-weight: bold;
      margin-top: 10px;
      font-family: monospace;
    }
    .lever-label {
      color: rgba(255,255,255,0.9);
      font-size: 12px;
      margin-bottom: 5px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .lever-buttons {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      justify-content: center;
    }
    .lever-btn {
      background: rgba(255,255,255,0.2);
      border: 1px solid rgba(255,255,255,0.3);
      color: white;
      padding: 5px 15px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      transition: background 0.2s;
    }
    .lever-btn:hover {
      background: rgba(255,255,255,0.3);
    }
  </style>
</head>
<body class="flex h-screen overflow-hidden">

  <!-- Mobile Overlay -->
  <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-20 lg:hidden hidden" onclick="toggleSidebar()"></div>

  <!-- Sidebar -->
  <aside id="sidebar" class="fixed lg:static inset-y-0 left-0 z-30 w-80 bg-white border-r border-slate-200 transform transition-transform duration-300 lg:transform-none -translate-x-full flex flex-col shadow-xl lg:shadow-lg no-print">
    <div class="p-4 border-b border-slate-200 flex justify-between items-center bg-gradient-to-r from-slate-50 to-white">
      <h2 class="font-semibold text-slate-800 flex items-center gap-2">
        <span class="text-indigo-600 text-xl">‚öôÔ∏è</span> Project Info
      </h2>
      <button class="lg:hidden text-slate-500 hover:text-slate-700 hover:bg-slate-100 rounded p-1 transition-colors" onclick="toggleSidebar()"><span class="icon-close"></span></button>
    </div>
    
    <div id="sidebar-content" class="flex-1 overflow-y-auto custom-scrollbar p-[11.56px] space-y-[17.34px]">
      <!-- Content injected by JS -->
    </div>

    <div class="p-4 border-t border-slate-200 bg-gradient-to-r from-slate-50 to-white flex gap-2">
       <button onclick="resetDefaults()" class="flex-1 py-2 px-3 bg-white border border-slate-300 rounded-lg text-xs font-medium text-slate-700 hover:bg-slate-50 hover:border-slate-400 hover:text-slate-900 transition-all shadow-sm hover:shadow">
         Reset Overrides
       </button>
       <button onclick="fullReset()" class="flex-1 py-2 px-3 bg-white border border-slate-300 rounded-lg text-xs font-medium text-slate-700 hover:bg-slate-50 hover:border-slate-400 hover:text-slate-900 transition-all shadow-sm hover:shadow">
         Reset All
       </button>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 flex flex-col h-full overflow-hidden relative bg-slate-50/50">
    <!-- Print Header -->
    <div id="print-header" class="hidden px-6 pt-6 relative">
       <div class="absolute top-6 right-6">
         <img src="images/LOGO_SEMPERGREEN.png" alt="Sempergreen Logo" class="h-12 w-auto" onerror="this.style.display='none'">
       </div>
       <h1 class="text-2xl font-semibold">Stormwater BMP Report</h1>
       <div id="print-info" class="mt-4 grid grid-cols-2 gap-4 text-sm border-t pt-4"></div>
    </div>

    <!-- Header -->
    <header class="bg-white border-b border-slate-200 h-16 flex items-center px-6 justify-between flex-shrink-0 shadow-md z-10 no-print">
      <div class="flex items-center gap-4">
        <button class="lg:hidden text-slate-600 hover:text-slate-800 hover:bg-slate-100 rounded p-1 transition-colors" onclick="toggleSidebar()"><span class="icon-menu text-xl"></span></button>
        <div>
          <h1 class="text-xl font-semibold text-slate-800 tracking-tight">Stormwater BMP Comparison Tool</h1>
          <p class="text-xs text-slate-500 font-normal">Real-time Viability & Cost Analysis</p>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <img src="images/LOGO_SEMPERGREEN.png" alt="Sempergreen Logo" class="h-10 w-auto hidden md:block opacity-90 hover:opacity-100 transition-opacity" onerror="this.style.display='none'">
        <button onclick="copyShareLink()" class="hidden md:flex items-center gap-2 px-4 py-2 bg-slate-600 text-white rounded-lg text-sm font-medium hover:bg-slate-700 transition-all shadow-md hover:shadow-lg">
          <span>Copy URL</span>
        </button>
        <button onclick="printReport()" class="hidden md:flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-medium hover:bg-indigo-700 transition-all shadow-md hover:shadow-lg">
          <span>Print</span>
        </button>
      </div>
    </header>

    <!-- Database Modal -->
    <div id="database-modal" class="hidden fixed inset-0 z-50 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4" onclick="if(event.target.id === 'database-modal') closeDatabaseModal()">
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-6xl max-h-[90vh] flex flex-col border border-slate-200" onclick="event.stopPropagation()">
        <div class="flex items-center justify-between p-6 border-b border-slate-200 bg-gradient-to-r from-slate-50 to-white rounded-t-2xl">
          <div class="flex items-center gap-4">
            <h2 class="text-xl font-semibold text-slate-800">üìä Database - BMP Library & Regulation Basis</h2>
            <label class="flex items-center gap-2 text-sm text-slate-700 cursor-pointer hover:text-indigo-600 transition-colors">
              <input type="checkbox" id="enable-editing-checkbox" onchange="toggleDatabaseEditing(this.checked)" class="rounded border-slate-300 text-indigo-600 focus:ring-2 focus:ring-indigo-500 focus:ring-offset-1">
              <span class="font-medium">Enable Editing</span>
            </label>
            <button id="save-defaults-btn" onclick="saveAsDefaults()" class="hidden px-4 py-2 bg-emerald-600 text-white rounded-lg text-sm font-medium hover:bg-emerald-700 transition-all shadow-md hover:shadow-lg">
              üíæ Save as Default
            </button>
          </div>
          <button onclick="closeDatabaseModal()" class="text-slate-500 hover:text-slate-700 hover:bg-slate-100 text-2xl font-bold w-9 h-9 flex items-center justify-center rounded-lg transition-all">&times;</button>
        </div>
        <div id="database-modal-content" class="flex-1 overflow-y-auto custom-scrollbar p-6">
          <!-- Content will be injected here -->
        </div>
      </div>
    </div>

    <!-- Dashboard -->
    <div class="flex-1 overflow-y-auto p-4 lg:p-6 custom-scrollbar">
      <div class="max-w-7xl mx-auto space-y-6 animate-fade-in">
        
        <!-- Metrics -->
        <div id="metrics-container" class="grid grid-cols-1 md:grid-cols-5 gap-3"></div>

        <!-- Site Conditions Display and Chart Toggle -->
        <div class="flex items-center justify-between gap-3 -mt-2 mb-1 no-print">
          <div id="site-conditions-display" class="flex-1 max-w-2xl"></div>
          <button onclick="toggleCostChart()" class="text-[10px] font-medium text-slate-400 hover:text-indigo-600 transition-colors whitespace-nowrap" title="Toggle Cost Chart">
             <span id="btn-toggle-cost-icon" class="text-sm">üëÅÔ∏è</span> <span id="btn-toggle-cost-text" class="hidden sm:inline">Cost</span>
          </button>
        </div>
        <div id="charts-container" class="grid grid-cols-1 lg:grid-cols-2 gap-6 transition-all duration-300">
          <div id="cost-chart-wrapper" class="glass p-6 rounded-xl transition-all duration-300 hidden">
             <div class="flex justify-between items-center mb-4 pb-3 border-b border-slate-100">
               <h3 class="font-semibold text-slate-800 text-base">Cost Comparison (Viable Options)</h3>
               <div class="text-xs text-slate-500 font-medium">Total Installed Cost</div>
             </div>
             <div class="h-64"><canvas id="cost-chart"></canvas></div>
          </div>
          <div id="perf-chart-wrapper" class="glass p-6 rounded-xl transition-all duration-300">
             <div class="flex justify-between items-center mb-4 pb-3 border-b border-slate-100">
               <h3 class="font-semibold text-slate-800 text-base">Performance vs Targets</h3>
               <div class="flex gap-2 text-xs">
                 <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-sky-500"></span> Ret</span>
                 <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-indigo-500"></span> Det</span>
               </div>
             </div>
             <div class="h-64"><canvas id="perf-chart"></canvas></div>
          </div>
        </div>

        <!-- Table & Detail -->
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
          <!-- Table -->
          <div class="xl:col-span-2 glass rounded-xl flex flex-col overflow-hidden">
             <div class="px-4 py-3 border-b border-slate-200 flex justify-between items-center bg-gradient-to-r from-white to-slate-50">
               <h3 class="font-semibold text-slate-800 text-base">Scenario Comparison</h3>
               <div id="asterisk-legend" class="text-[9px] text-amber-600 font-medium"></div>
             </div>
             <div class="overflow-visible bg-white">
               <div class="overflow-x-auto">
                 <table class="w-full text-xs text-left min-w-full">
                   <thead class="text-[10px] text-slate-600 uppercase bg-gradient-to-r from-slate-50 to-slate-100 border-b-2 border-slate-300">
                     <tr>
                       <th class="px-1.5 py-1.5 font-semibold text-center w-8">Include</th>
                       <th class="px-1.5 py-1.5 font-semibold text-center w-10">Viable</th>
                       <th class="px-2 py-1.5 font-semibold text-left w-auto min-w-[250px] max-w-[350px]">Strategy</th>
                       <th class="px-1.5 py-1.5 font-semibold text-right w-20">Cost ($)</th>
                       <th class="px-1.5 py-1.5 font-semibold text-right w-18">Avail (SF)</th>
                       <th class="px-1.5 py-1.5 font-semibold text-right w-18"><span class="text-indigo-600" title="Editable - click to modify">Used (SF)</span></th>
                       <th class="px-1.5 py-1.5 font-semibold text-right w-18">Ret (CF)</th>
                       <th class="px-1.5 py-1.5 font-semibold text-right w-18">Det (CF)</th>
                       <th class="px-1.5 py-1.5 font-semibold text-right w-20">Storage (CF)</th>
                     </tr>
                   </thead>
                   <tbody id="scenario-table-body" class="divide-y divide-slate-100"></tbody>
                 </table>
               </div>
             </div>
          </div>

          <!-- Detail Panel -->
          <div id="detail-panel" class="xl:col-span-1 glass-dark rounded-xl flex flex-col overflow-hidden max-h-[calc(100vh-300px)]">
            <!-- Injected by JS -->
          </div>
        </div>

      </div>
    </div>
    
    <!-- Print Footer - appears at end of content (last page) -->
    <div id="print-footer" class="hidden pb-10 px-6 mt-8">
       <div class="mb-2 font-semibold text-sm">Report generated by Stormwater BMP Comparison Tool</div>
       <div class="text-[10px] text-slate-600 mt-2">
         <span>Configuration link: </span>
         <a id="print-link" href="#" class="text-blue-600 underline inline" style="word-break: break-all; overflow-wrap: anywhere;"></a>
       </div>
    </div>
  </main>

<script>
/**
 * DATA MODELS & CONSTANTS
 */

const REGULATION_PROFILES = {
  general: {
    id: 'general',
    label: 'General Defaults',
    defaults: { soilRetentionPct: 0.40, nmwRetentionPct: 0.80, honeycombVoidPct: 0.95 },
    rules: { nmwRetentionRequiresMinSoilCoverIn: 0 }
  },
  nyc_dep: {
    id: 'nyc_dep',
    label: 'NYC DEP',
    defaults: { soilRetentionPct: 0.20, nmwRetentionPct: 0.40, honeycombVoidPct: 0.95 },
    rules: { nmwRetentionRequiresMinSoilCoverIn: 4.0 }
  }
};

const BMP_OPTIONS = [
  { id: 1, name: "Landscape Pond (at grade)", areaType: 'atGrade_pervious', unitPrice: 15, specs: { freeboard: 18, soilDepth: 24, soilPorosity: 0.15, gravelDepth: 24, gravelPorosity: 0.50, spaceLoss: 0.20 } },
  { id: 2, name: "Underground Cells / Crates", areaType: 'atGrade_combined', unitPrice: 25, specs: { storageDepth: 36, voidRatio: 0.95, freeboard: 6, spaceLoss: 0.15 } }, // Eligible: Usable landscape + all at-grade pavement (vehicular + pedestrian)
  { id: 3, name: "Permeable Pavers", areaType: 'atGrade_ped', unitPrice: 35, specs: { reservoirDepth: 18, voidRatio: 0.40, spaceLoss: 0.10 } },
  { id: 4, name: "Below Grade Tank (Dead Space)", areaType: 'atGrade_landscape_veh', unitPrice: 45, specs: { detentionDepth: 72, freeboard: 24, spaceLoss: 0.15 } }, // No other ROI - area has no alternative use. Eligible: Usable Landscape + Vehicular Pavement only
  { id: 5, name: "Below Grade Tank (Usable Space)", areaType: 'atGrade_landscape_veh', unitPrice: 55, specs: { detentionDepth: 72, freeboard: 24, spaceLoss: 0.20 } }, // Decreases ROI - takes usable interior space that could be used for other programming. Eligible: Usable Landscape + Vehicular Pavement only
  { id: 6, name: "On-Structure Tank (Usable Space)", areaType: 'on_structure_tank', unitPrice: 50, specs: { detentionDepth: 72, freeboard: 24, spaceLoss: 0.15 } }, // Always in usable space, loses building ROI by taking tank space. Eligible: Flat Deck/Plaza + Sloped Roof + Pavers on Structure (NOT CA/Untreated)
  { id: 7, name: "Blue Roof Cells 6\"", areaType: 'flatDeck_strict', unitPrice: 40, specs: { storageDepth: 3, voidRatio: 0.95, freeboard: 0, spaceLoss: 0.05 } }, // Eligible: Flat deck / Plaza only
  { id: 8, name: "Traditional Green Roof 6\"", areaType: 'sloped_roof', unitPrice: 25, specs: { mediaDepth: 4, detLayerDepth: 0, detVoidRatio: 0.95, spaceLoss: 0.05 } }, // Eligible: Sloped roof only
  { id: 9, name: "Sponge Roof 4+2", areaType: 'sloped_roof', unitPrice: 26, specs: { mediaDepth: 4, nmwDepth: 2, spaceLoss: 0.05 } }, // Eligible: Sloped roof only
  { id: 10, name: "Purple-Roof (Vegetated) 4+1+2", areaType: 'sloped_roof_or_flat_deck', unitPrice: 40, specs: { soilDepth: 4, soilPorosity: 0.20, nmwDepth: 1, nmwPorosity: 0.93, hcDepth: 2, hcVoidRatio: 0.95, dlDepth: 0.2, dlPorosity: 0.93, spaceLoss: 0.05 }, extra: { pricingMode: 'black', pricingUpgrade: 15, pricingBase: 40 } }, // Eligible: Sloped roof or Flat deck/Plaza
  { id: '10B', name: "Purple-Roof (Vegetated) 4+1+4", areaType: 'sloped_roof_or_flat_deck', unitPrice: 40, specs: { soilDepth: 4, soilPorosity: 0.20, nmwDepth: 1, nmwPorosity: 0.93, hcDepth: 4, hcVoidRatio: 0.95, dlDepth: 0.2, dlPorosity: 0.93, spaceLoss: 0.05 }, extra: { pricingMode: 'black', pricingUpgrade: 15, pricingBase: 40 } }, // Eligible: Sloped roof or Flat deck/Plaza
  { id: 11, name: "Purple-Roof (Pavers) P+1+2", areaType: 'pavers_or_sloped_or_flat_deck', unitPrice: 40, specs: { hcDepth: 2, hcVoidRatio: 0.95, nmwDepth: 1, nmwRetentionPct: 0.80, spaceLoss: 0.05 } }, // Eligible: Pavers on structure, Sloped roof, or Flat deck/Plaza
  { id: '11B', name: "Purple-Roof (Pavers) P+1+4", areaType: 'pavers_or_sloped_or_flat_deck', unitPrice: 40, specs: { hcDepth: 4, hcVoidRatio: 0.95, nmwDepth: 1, nmwRetentionPct: 0.80, spaceLoss: 0.05 } } // Eligible: Pavers on structure, Sloped roof, or Flat deck/Plaza
];

// BMP Image Mapping
const BMP_IMAGES = {
  1: 'images/IMAGE-bioretention-cell.png', // Landscape Pond - using bioretention as closest match
  2: 'images/IMAGE-underground-passive-cells.png', // Underground Cells / Crates
  3: 'images/IMAGE-perm-pavers.png', // Permeable Pavers
  4: 'images/IMAGE-underground tank and pump.png', // Below Grade Tank (Dead Space)
  5: 'images/IMAGE-underground tank and pump.png', // Below Grade Tank (Usable Space)
  6: 'images/IMAGE-underground tank and pump.png', // On-Structure Tank (Usable Space)
  7: 'images/IMAGE-blue-roof.png', // Blue Roof Cells 6"
  8: 'images/IMAGE-trad-green-roof-6.png', // Traditional Green Roof 6"
  9: 'images/IMAGE-sponge4+2.png', // Sponge Roof 4+2
  10: 'images/IMAGE-purple-veg-4+1+2.png', // Purple-Roof (Vegetated) 4+1+2
  '10B': 'images/IMAGE-purple-veg-4+1+4.png', // Purple-Roof (Vegetated) 4+1+4
  11: 'images/IMAGE-purple-paver+1+2.png', // Purple-Roof (Pavers) P+1+2
  '11B': 'images/IMAGE-purple-paver+1+4.png' // Purple-Roof (Pavers) P+1+4
};

// Feature flag: Set to false to disable lever controls
const ENABLE_LEVERS = false;

const INITIAL_STATE = {
  regulationProfileId: 'general',
  selectedScenarioIds: [],
  inputs: {
    projectName: '', projectAddress: '', clientName: '',
    imperviousVehicularPavement: 1000, imperviousPedestrianPavement: 1000, perviousLandscapingUsable: 1000, perviousTreeCoverNonUsable: 1000,
    flatDeckOnStructureArea: 1000, slopedRoofArea: 1000, paversOnStructureArea: 1000, imperviousCAUntreated: 1000,
    targetDetentionCF: 100, targetRetentionCF: 100,
    detentionNeeded: true, retentionNeeded: true,
    greenRoofAlreadyInScope: false, programmableSpaceIsHighValue: false,
    hasUndergroundUtilities: false, hasHighWaterTable: false, hasContaminatedSoil: false,
    allowSteepSlopeGreenRoof: false
  },
  showCostChart: false,
  overrides: {}
};

let state = JSON.parse(JSON.stringify(INITIAL_STATE));

function getRegulationProfile() { return REGULATION_PROFILES[state.regulationProfileId]; }

function getSpec(bmpId) {
  const defaults = BMP_OPTIONS.find(b => b.id == bmpId);
  const override = state.overrides[bmpId] || {};
  const specs = { ...defaults.specs, ...(override.specs || {}) };
  const unitPrice = override.unitPrice !== undefined ? override.unitPrice : defaults.unitPrice;
  const extra = { ...defaults.extra, ...(override.extra || {}) };
  return { specs, unitPrice, extra };
}

function getEligibleArea(bmp, inputs) {
  // All at-grade usable areas (excludes tree cover / non-usable)
  const allAtGradeUsable = inputs.perviousLandscapingUsable + inputs.imperviousVehicularPavement + inputs.imperviousPedestrianPavement;
  // Flat deck / Plaza areas (blue roof eligible only)
  const flatDeckPlaza = inputs.flatDeckOnStructureArea;
  // Sloped roof areas (green/purple/sponge/traditional green roofs only)
  const slopedRoof = inputs.slopedRoofArea;
  // Pavers on structure (purple roof paver eligible only)
  const paversOnStructure = inputs.paversOnStructureArea;
  // All on-structure areas (any of the 4 on-structure area types)
  const allOnStructure = inputs.flatDeckOnStructureArea + inputs.slopedRoofArea + inputs.paversOnStructureArea + inputs.imperviousCAUntreated;
  
  switch(bmp.areaType) {
    case 'atGrade_pervious': 
      // Landscape Pond: Usable landscape only
      return inputs.perviousLandscapingUsable;
    case 'atGrade_combined': 
      // Underground Cells: Usable landscape + all at-grade pavement (vehicular + pedestrian)
      return inputs.perviousLandscapingUsable + inputs.imperviousVehicularPavement + inputs.imperviousPedestrianPavement;
    case 'atGrade_ped': 
      // Permeable Pavers: Pedestrian pavement only
      return inputs.imperviousPedestrianPavement;
    case 'atGrade_landscape_veh': 
      // Below Grade Tanks (BMP 4 & 5): Usable Landscape + Vehicular Pavement only (NOT pedestrian pavement)
      return inputs.perviousLandscapingUsable + inputs.imperviousVehicularPavement;
    case 'on_structure_tank': 
      // On-Structure Tank (BMP 6): Flat Deck/Plaza + Sloped Roof + Pavers on Structure (NOT CA/Untreated)
      return flatDeckPlaza + slopedRoof + paversOnStructure;
    case 'flatDeck_strict': 
      // Blue Roof Cells: Flat deck / Plaza only
      return flatDeckPlaza;
    case 'sloped_roof': 
      // Traditional Green Roof, Sponge Roof: Sloped roof only
      return slopedRoof;
    case 'sloped_roof_or_flat_deck': 
      // Purple-Roof Vegetated: Sloped roof or Flat deck/Plaza
      return slopedRoof + flatDeckPlaza;
    case 'pavers_on_structure': 
      // (Not currently used - Purple-Roof Pavers now use pavers_or_flat_deck)
      return paversOnStructure;
    case 'pavers_or_flat_deck': 
      // (Not currently used - Purple-Roof Pavers now use pavers_or_sloped_or_flat_deck)
      return paversOnStructure + flatDeckPlaza;
    case 'pavers_or_sloped_or_flat_deck': 
      // Purple-Roof Pavers: Pavers on structure, Sloped roof, or Flat deck/Plaza
      return paversOnStructure + slopedRoof + flatDeckPlaza;
    default: return 0;
  }
}

function calculateCapacity(bmpId, fullSpec, profile) {
  const { specs } = fullSpec;
  let inRet = 0, inDet = 0;
  const soilRet = profile.defaults.soilRetentionPct;
  const nmwRet = profile.defaults.nmwRetentionPct;
  const voidRatio = profile.defaults.honeycombVoidPct;
  const nmwEffectiveRet = (profile.rules.nmwRetentionRequiresMinSoilCoverIn > 0 && (specs.soilDepth || specs.mediaDepth || 0) < profile.rules.nmwRetentionRequiresMinSoilCoverIn) ? 0 : nmwRet;

  if (bmpId == 1) { inRet = specs.soilDepth * soilRet; inDet = specs.freeboard + (specs.soilDepth * specs.soilPorosity) + (specs.gravelDepth * specs.gravelPorosity); }
  else if (bmpId == 2) { inDet = specs.freeboard + (specs.storageDepth * specs.voidRatio); }
  else if (bmpId == 3) { inDet = specs.reservoirDepth * specs.voidRatio; }
  else if ([4,5,6].includes(bmpId)) { inDet = specs.detentionDepth; }
  else if (bmpId == 7) { inDet = specs.freeboard + (specs.storageDepth * specs.voidRatio); }
  else if (bmpId == 8) { inRet = specs.mediaDepth * soilRet; inDet = specs.detLayerDepth * specs.detVoidRatio; }
  else if (bmpId == 9) { inRet = (specs.mediaDepth * soilRet) + (specs.nmwDepth * nmwEffectiveRet); }
  else if (bmpId == 10 || bmpId == '10B') { inRet = (specs.soilDepth * soilRet) + (specs.nmwDepth * nmwEffectiveRet); const hcVoid = specs.hcVoidRatio || voidRatio; inDet = (specs.soilDepth * specs.soilPorosity) + (specs.hcDepth * hcVoid) + (specs.dlDepth * specs.dlPorosity); }
  else if (bmpId == 11 || bmpId == '11B') {
      let hardscapeNmwRet = specs.nmwRetentionPct !== undefined ? specs.nmwRetentionPct : nmwRet;
      if (profile.rules.nmwRetentionRequiresMinSoilCoverIn > 0) hardscapeNmwRet = 0;
      inRet = specs.nmwDepth * hardscapeNmwRet;
      const hardscapeHcVoid = specs.hcVoidRatio || voidRatio;
      inDet = specs.hcDepth * hardscapeHcVoid;
  }
  
  return { cfRetPerSf: inRet / 12.0, cfDetPerSf: inDet / 12.0, nmwRestricted: (profile.rules.nmwRetentionRequiresMinSoilCoverIn > 0 && (specs.soilDepth || specs.mediaDepth || 0) < profile.rules.nmwRetentionRequiresMinSoilCoverIn) };
}

function runCalculations() {
  const { inputs } = state;
  const profile = getRegulationProfile();
  // Total Site Area = All On-Structure Areas + All At-Grade Areas
  const onStructureTotal = inputs.flatDeckOnStructureArea + inputs.slopedRoofArea + inputs.paversOnStructureArea + inputs.imperviousCAUntreated;
  const atGradeTotal = inputs.perviousLandscapingUsable + inputs.imperviousVehicularPavement + inputs.imperviousPedestrianPavement + inputs.perviousTreeCoverNonUsable;
  const contributingTotalSiteArea = onStructureTotal + atGradeTotal;
  
  const results = BMP_OPTIONS.map(bmp => {
    const fullSpec = getSpec(bmp.id);
    const capacity = calculateCapacity(bmp.id, fullSpec, profile);
    const eligibleArea = getEligibleArea(bmp, inputs);
    
    let areaForRet = 0, areaForDet = 0;
    if (inputs.targetRetentionCF > 0 && capacity.cfRetPerSf > 0) areaForRet = inputs.targetRetentionCF / capacity.cfRetPerSf;
    else if (inputs.targetRetentionCF > 0) areaForRet = Infinity;
    
    if (inputs.targetDetentionCF > 0 && capacity.cfDetPerSf > 0) areaForDet = inputs.targetDetentionCF / capacity.cfDetPerSf;
    else if (inputs.targetDetentionCF > 0) areaForDet = Infinity;
    
    const effectiveAreaForRet = (bmp.id == 11 || bmp.id == '11B') ? 0 : areaForRet;
    const netAreaNeeded = Math.max(effectiveAreaForRet, areaForDet);
    let grossAreaNeeded = netAreaNeeded === Infinity ? Infinity : netAreaNeeded / (1 - fullSpec.specs.spaceLoss);
    
    if (netAreaNeeded === Infinity) {
        if (areaForRet === Infinity && areaForDet < Infinity) grossAreaNeeded = areaForDet / (1 - fullSpec.specs.spaceLoss);
        else if (areaForDet === Infinity && areaForRet < Infinity) grossAreaNeeded = areaForRet / (1 - fullSpec.specs.spaceLoss);
    }
    
    let designArea = grossAreaNeeded;
    if (grossAreaNeeded > eligibleArea && grossAreaNeeded !== Infinity) {
         const grossRetNeeded = areaForRet === Infinity ? Infinity : areaForRet / (1 - fullSpec.specs.spaceLoss);
         const grossDetNeeded = areaForDet === Infinity ? Infinity : areaForDet / (1 - fullSpec.specs.spaceLoss);
         const canMeetDet = grossDetNeeded <= eligibleArea;
         const canMeetRet = grossRetNeeded <= eligibleArea;
         if (canMeetDet && !canMeetRet) designArea = grossDetNeeded;
         else if (canMeetRet && !canMeetDet) designArea = grossRetNeeded;
         else designArea = eligibleArea;
    }
    
    // If design area is very small (< 100 sf) but eligible area is available, size to at least 100 sf
    // (or eligible area if less than 100 sf) to meet minimum footprint requirement
    if (designArea !== Infinity && designArea < 100 && eligibleArea > 0 && (inputs.targetDetentionCF > 0 || inputs.targetRetentionCF > 0)) {
      designArea = Math.min(100, eligibleArea);
    }

    let grossEligibleUsed = Math.min(eligibleArea, (designArea === Infinity ? eligibleArea : designArea));
    if (state.overrides[bmp.id] && state.overrides[bmp.id].manualArea !== undefined && state.overrides[bmp.id].manualArea !== '') {
         grossEligibleUsed = parseFloat(state.overrides[bmp.id].manualArea);
    }
    
    const netEligibleUsed = grossEligibleUsed * (1 - fullSpec.specs.spaceLoss);
    const retDesigned = netEligibleUsed * capacity.cfRetPerSf;
    const detDesigned = netEligibleUsed * capacity.cfDetPerSf;
    
    let unitPrice = fullSpec.unitPrice;
    if (bmp.id == 10 || bmp.id == '10B') {
       unitPrice = fullSpec.extra.pricingMode === 'green' ? fullSpec.extra.pricingUpgrade : fullSpec.extra.pricingBase;
    }
    const costDesigned = grossEligibleUsed * unitPrice;
    
    const blockers = [], warnings = [];
    if (grossAreaNeeded > eligibleArea && eligibleArea > 0) {
      // Only block if we have area but it's not enough - if no area at all, that's a different issue
      warnings.push(`Insufficient Area (Need ${Math.ceil(grossAreaNeeded).toLocaleString()} sf, Have ${Math.ceil(eligibleArea).toLocaleString()} sf)`);
    }
    if (eligibleArea === 0) {
      blockers.push("No eligible area available");
    }
    
    // Minimum footprint requirement of 100 sf for reasonable cost estimates (only when targets are set)
    if (grossEligibleUsed > 0 && grossEligibleUsed < 100 && (inputs.targetDetentionCF > 0 || inputs.targetRetentionCF > 0)) {
      blockers.push("Minimum footprint requirement: 100 sf (for reasonable cost estimates)");
    }
    
    if (netAreaNeeded === Infinity) {
       const failsRet = areaForRet === Infinity;
       const failsDet = areaForDet === Infinity;
       // Don't block if it can't meet targets - it can still be used in combination
       // Only warn about 0 capacity
       if (failsRet && failsDet) warnings.push("Cannot meet Retention or Detention targets alone (0 capacity)");
       else if (failsRet) warnings.push("Fails Retention target (0 capacity)");
       else if (failsDet) warnings.push("Fails Detention target (0 capacity)");
    }
    
    const isUnderground = [2, 3, 4, 5].includes(bmp.id); // Underground Cells, Permeable Pavers, Below Grade Tanks
    const isAtGradePond = bmp.id === 1; // Landscape Pond
    if (isUnderground || isAtGradePond) {
      if (inputs.hasUndergroundUtilities) blockers.push("Blocked by Underground Utilities");
      if (inputs.hasHighWaterTable) blockers.push("Blocked by High Water Table");
      if (inputs.hasContaminatedSoil) blockers.push("Blocked by Contaminated Soil");
    }
    
    // Retention-only products (cannot provide detention) - block on detention-only projects
    // Check if product has zero detention capacity and project requires detention but not retention
    if (capacity.cfDetPerSf === 0 && inputs.targetRetentionCF === 0 && inputs.targetDetentionCF > 0) {
      blockers.push("Cannot provide detention - retention-only product");
    }
    
    // Traditional Green Roof and Sponge Roof require retention to be needed
    if ((bmp.id === 8 || bmp.id === 9) && !inputs.retentionNeeded) {
      blockers.push("Requires retention target to be needed");
    }
    
    // Traditional Green Roof and Sponge Roof require sloped roof (not flat deck/plaza)
    if ((bmp.id === 8 || bmp.id === 9) && inputs.slopedRoofArea === 0) {
      blockers.push("Requires Sloped Roof area");
    }
    
    // Purple-Roof Vegetated requires sloped roof OR flat deck/plaza
    if ((bmp.id === 10 || bmp.id === '10B') && inputs.slopedRoofArea === 0 && inputs.flatDeckOnStructureArea === 0) {
      blockers.push("Requires Sloped Roof or Flat Deck/Plaza area");
    }
    
    // Purple-Roof Pavers requires pavers on structure OR sloped roof OR flat deck/plaza
    if ((bmp.id === 11 || bmp.id === '11B') && inputs.paversOnStructureArea === 0 && inputs.slopedRoofArea === 0 && inputs.flatDeckOnStructureArea === 0) {
      blockers.push("Requires Pavers on Structure, Sloped Roof, or Flat Deck/Plaza area");
    }
    
    // On-Structure Tank only viable when Flat Deck/Plaza, Sloped Roof, or Pavers on Structure is available (NOT CA/Untreated)
    if (bmp.id === 6 && inputs.flatDeckOnStructureArea === 0 && inputs.slopedRoofArea === 0 && inputs.paversOnStructureArea === 0) {
      blockers.push("Requires Flat Deck/Plaza, Sloped Roof, or Pavers on Structure area");
    }
    
    // Blue Roof Cells only viable when Flat Deck / Plaza area is available
    if (bmp.id === 7 && inputs.flatDeckOnStructureArea === 0) {
      blockers.push("Requires Flat Deck / Plaza area");
    }
    
    // Landscape Pond only viable with Usable Landscape
    if (bmp.id === 1 && inputs.perviousLandscapingUsable === 0) {
      blockers.push("Requires Usable Landscape area");
    }
    
    // Below Grade Tanks (BMP 4 - Dead Space): Tank in area with no other ROI (no opportunity cost)
    // Allowed when no underground conflicts and Usable Landscape or Vehicular Pavement (NOT pedestrian pavement)
    if (bmp.id === 4 && inputs.perviousLandscapingUsable === 0 && inputs.imperviousVehicularPavement === 0) {
      blockers.push("Requires Usable Landscape or Vehicular Pavement area");
    }
    // Below Grade Tanks (BMP 5 - Usable Space): Tank in usable interior space, decreases ROI of that space
    // Takes away space that could be used for other programming inside building (higher opportunity cost)
    // Allowed in Usable Landscape or Vehicular Pavement where interior usable space can be created (NOT pedestrian pavement)
    if (bmp.id === 5 && inputs.perviousLandscapingUsable === 0 && inputs.imperviousVehicularPavement === 0) {
      blockers.push("Requires Usable Landscape or Vehicular Pavement area for interior usable space");
    }
    
    if (capacity.nmwRestricted) warnings.push("NYC DEP: NMW credit reduced (requires ‚â•4\" soil)");
    if (inputs.targetRetentionCF > 0 && retDesigned < inputs.targetRetentionCF * 0.99) {
        if (!warnings.some(w => w.includes("Fails Retention") || w.includes("meet Retention"))) warnings.push("Does not meet full Retention target (can be used in combination)");
    }
    if (inputs.targetDetentionCF > 0 && detDesigned < inputs.targetDetentionCF * 0.99) {
        if (!warnings.some(w => w.includes("Fails Detention") || w.includes("meet Detention"))) warnings.push("Does not meet full Detention target (can be used in combination)");
    }
    
    return {
      ...bmp, fullSpec, capacity, eligibleArea, grossAreaNeeded, grossDesignedArea: grossEligibleUsed,
      retDesigned, detDesigned, costDesigned, isViable: blockers.length === 0, blockers, warnings, unitPrice
    };
  });
  
  const viable = results.filter(r => r.isViable);
  const recommended = viable.length > 0 ? viable[0] : null;
  const bestValue = viable.length > 0 ? viable.reduce((p, c) => p.costDesigned < c.costDesigned ? p : c) : null;
  
  return { results, recommended, bestValue, areas: { contributingTotalSiteArea }, profile };
}

function updateInput(key, val) {
  if (val === 'true') val = true;
  if (val === 'false') val = false;
  if (['impervious', 'pervious', 'flatDeck', 'slopedRoof', 'target', 'Area', 'pavers'].some(k => key.includes(k))) val = parseFloat(val) || 0;
  state.inputs[key] = val;
  process();
}

function updateSpec(bmpId, key, val) {
  if (!state.overrides[bmpId]) state.overrides[bmpId] = { specs: {} };
  if (!state.overrides[bmpId].specs) state.overrides[bmpId].specs = {};
  state.overrides[bmpId].specs[key] = parseFloat(val);
  process();
}

// Lever Control Functions
let leverDragging = false;
let leverCurrentId = null;
let leverMaxValue = 0;

function showLever(bmpId, currentValue, maxValue) {
  if (!ENABLE_LEVERS) return; // Easy disable flag
  const lever = document.getElementById(`lever-${bmpId}`);
  const input = document.getElementById(`input-used-${bmpId}`);
  if (!lever || !input) return;
  
  // Use eligibleArea as max, ensure it's at least currentValue
  leverMaxValue = Math.max(maxValue || currentValue, currentValue);
  if (leverMaxValue === 0) leverMaxValue = 1000; // Fallback if no area available
  
  // Center lever in viewport like images
  lever.style.visibility = 'visible';
  lever.style.opacity = '0';
  lever.style.left = '0';
  lever.style.top = '0';
  
  // Force reflow to get dimensions
  void lever.offsetWidth;
  
  const leverRect = lever.getBoundingClientRect();
  const viewportWidth = window.innerWidth;
  const viewportHeight = window.innerHeight;
  
  // Center horizontally and vertically in viewport
  let left = (viewportWidth - leverRect.width) / 2;
  let top = (viewportHeight - leverRect.height) / 2;
  
  // Ensure lever stays within viewport bounds with padding
  const padding = 20;
  left = Math.max(padding, Math.min(left, viewportWidth - leverRect.width - padding));
  top = Math.max(padding, Math.min(top, viewportHeight - leverRect.height - padding));
  
  lever.style.left = left + 'px';
  lever.style.top = top + 'px';
  lever.style.transform = 'none';
  lever.classList.add('show');
  
  // Set initial lever position
  updateLeverPosition(bmpId, currentValue);
  
  // Show it
  setTimeout(() => {
    lever.style.opacity = '1';
  }, 10);
}

function hideLever(bmpId) {
  if (!leverDragging && leverCurrentId !== bmpId) {
    const lever = document.getElementById(`lever-${bmpId}`);
    if (lever) {
      lever.style.opacity = '0';
      setTimeout(() => {
        if (!leverDragging) {
          lever.classList.remove('show');
          lever.style.visibility = 'hidden';
        }
      }, 200);
    }
  }
}

function updateLeverPosition(bmpId, value) {
  const handle = document.getElementById(`handle-${bmpId}`);
  const valueDisplay = document.getElementById(`lever-value-${bmpId}`);
  const track = document.getElementById(`track-${bmpId}`);
  if (!handle || !valueDisplay || !track) return;
  
  // Calculate percentage from 0 to leverMaxValue
  const percentage = leverMaxValue > 0 ? Math.min(100, Math.max(0, (value / leverMaxValue) * 100)) : 0;
  const maxLeft = track.offsetWidth - handle.offsetWidth;
  handle.style.left = (maxLeft * percentage / 100) + 'px';
  valueDisplay.textContent = Math.round(value).toLocaleString() + ' sf / ' + Math.round(leverMaxValue).toLocaleString() + ' sf';
}

function startDrag(e, bmpId) {
  e.preventDefault();
  e.stopPropagation();
  e.stopImmediatePropagation();
  leverDragging = true;
  leverCurrentId = bmpId;
  
  const handle = document.getElementById(`handle-${bmpId}`);
  const track = document.getElementById(`track-${bmpId}`);
  if (!handle || !track) return;
  
  const trackRect = track.getBoundingClientRect();
  const handleRect = handle.getBoundingClientRect();
  const startX = e.clientX;
  const startLeft = handleRect.left - trackRect.left;
  const maxLeft = track.offsetWidth - handle.offsetWidth;
  
  function onMouseMove(e) {
    e.preventDefault();
    e.stopPropagation();
    const deltaX = e.clientX - startX;
    const newLeft = Math.max(0, Math.min(maxLeft, startLeft + deltaX));
    handle.style.left = newLeft + 'px';
    
    // Calculate value from 0 to leverMaxValue
    const percentage = maxLeft > 0 ? newLeft / maxLeft : 0;
    const newValue = Math.round(percentage * leverMaxValue);
    updateLeverValue(bmpId, newValue, false); // Don't trigger process during drag
  }
  
  function onMouseUp(e) {
    e.preventDefault();
    e.stopPropagation();
    leverDragging = false;
    const wasCurrent = leverCurrentId === bmpId;
    leverCurrentId = null;
    document.removeEventListener('mousemove', onMouseMove);
    document.removeEventListener('mouseup', onMouseUp);
    
    // Final update with process
    const handle = document.getElementById(`handle-${bmpId}`);
    const track = document.getElementById(`track-${bmpId}`);
    if (handle && track) {
      const maxLeft = track.offsetWidth - handle.offsetWidth;
      const percentage = maxLeft > 0 ? parseFloat(handle.style.left) / maxLeft : 0;
      const finalValue = Math.round(percentage * leverMaxValue);
      updateLeverValue(bmpId, finalValue, true); // Trigger process on release
    }
    
    // Hide lever after a short delay
    setTimeout(() => {
      if (!leverDragging && wasCurrent) {
        const lever = document.getElementById(`lever-${bmpId}`);
        if (lever) {
          lever.style.opacity = '0';
          setTimeout(() => {
            lever.classList.remove('show');
            lever.style.visibility = 'hidden';
          }, 200);
        }
      }
    }, 300);
  }
  
  document.addEventListener('mousemove', onMouseMove, { passive: false });
  document.addEventListener('mouseup', onMouseUp, { passive: false });
}

function adjustLeverValue(bmpId, delta) {
  const input = document.getElementById(`input-used-${bmpId}`);
  if (!input) return;
  
  const currentValue = parseFloat(input.value) || 0;
  const newValue = Math.max(0, Math.min(leverMaxValue, currentValue + delta));
  updateLeverValue(bmpId, newValue, true);
}

function updateLeverValue(bmpId, value, triggerProcess = true) {
  const input = document.getElementById(`input-used-${bmpId}`);
  if (!input) return;
  
  // Clamp value between 0 and leverMaxValue
  const clampedValue = Math.max(0, Math.min(leverMaxValue, Math.round(value)));
  input.value = clampedValue;
  
  if (triggerProcess) {
    updateManualArea(bmpId, clampedValue);
  }
  updateLeverPosition(bmpId, clampedValue);
}

function updateManualArea(bmpId, val) {
  if (!state.overrides[bmpId]) state.overrides[bmpId] = {};
  if (val === '' || val === null) delete state.overrides[bmpId].manualArea;
  else state.overrides[bmpId].manualArea = parseFloat(val);
  process();
}

function updatePrice(bmpId, val) {
  if (!state.overrides[bmpId]) state.overrides[bmpId] = {};
  state.overrides[bmpId].unitPrice = parseFloat(val);
  process();
}

function updateExtra(bmpId, key, val) {
  if (!state.overrides[bmpId]) state.overrides[bmpId] = { extra: {} };
  if (!state.overrides[bmpId].extra) state.overrides[bmpId].extra = {};
  state.overrides[bmpId].extra[key] = val;
  process();
}

function setProfile(id) { state.regulationProfileId = id; process(); }

function addNewRegulation() {
  const cityName = prompt('Enter city name for new regulation profile:');
  if (!cityName || cityName.trim() === '') return;
  
  const soilRet = parseFloat(prompt('Soil Retention % (e.g., 0.40 for 40%):') || '0.40');
  const nmwRet = parseFloat(prompt('NMW Retention % (e.g., 0.80 for 80%):') || '0.80');
  const honeycombVoid = parseFloat(prompt('Honeycomb Void % (e.g., 0.95 for 95%):') || '0.95');
  const minSoilCover = parseFloat(prompt('Minimum soil cover for NMW credit (inches, 0 for none):') || '0');
  
  const newId = cityName.toLowerCase().replace(/\s+/g, '_');
  REGULATION_PROFILES[newId] = {
    id: newId,
    label: cityName,
    defaults: { soilRetentionPct: soilRet, nmwRetentionPct: nmwRet, honeycombVoidPct: honeycombVoid },
    rules: { nmwRetentionRequiresMinSoilCoverIn: minSoilCover }
  };
  
  state.regulationProfileId = newId;
  process();
  alert(`Added "${cityName}" regulation profile. It is now selected.`);
}
function selectScenario(id) {
  const existing = state.selectedScenarioIds.find(sid => sid == id);
  if (existing !== undefined) state.selectedScenarioIds = state.selectedScenarioIds.filter(sid => sid != id);
  else state.selectedScenarioIds.push(id);
  process();
}

function toggleSidebar() {
  const sb = document.getElementById('sidebar');
  const ov = document.getElementById('sidebar-overlay');
  sb.classList.toggle('-translate-x-full');
  ov.classList.toggle('hidden');
}

function resetDefaults() { state.overrides = {}; process(); saveStateToUrl(); }
function fullReset() { 
  if (confirm('Reset all project inputs to zero? This will NOT reset your database edits (specs, pricing, regulation profiles), but will reset all "used sf" values.')) { 
    // Preserve only database edits (specs, unitPrice, extra), but remove manualArea (used sf)
    const savedOverrides = {};
    for (const bmpId in state.overrides) {
      const override = state.overrides[bmpId];
      savedOverrides[bmpId] = {};
      if (override.specs) savedOverrides[bmpId].specs = { ...override.specs };
      if (override.unitPrice !== undefined) savedOverrides[bmpId].unitPrice = override.unitPrice;
      if (override.extra) savedOverrides[bmpId].extra = { ...override.extra };
      // Explicitly do NOT preserve manualArea - it will be reset
    }
    // Reset all inputs to zero/empty while preserving structure
    state.inputs = {
      projectName: '', projectAddress: '', clientName: '',
      imperviousVehicularPavement: 0, imperviousPedestrianPavement: 0, perviousLandscapingUsable: 0, perviousTreeCoverNonUsable: 0,
      flatDeckOnStructureArea: 0, slopedRoofArea: 0, paversOnStructureArea: 0, imperviousCAUntreated: 0,
      targetDetentionCF: 0, targetRetentionCF: 0,
      detentionNeeded: true, retentionNeeded: true,
      greenRoofAlreadyInScope: false, programmableSpaceIsHighValue: false,
      hasUndergroundUtilities: false, hasHighWaterTable: false, hasContaminatedSoil: false,
      allowSteepSlopeGreenRoof: false
    };
    state.selectedScenarioIds = [];
    state.overrides = savedOverrides; // Restore only database edits (no manualArea)
    process(); 
    saveStateToUrl(); // Save to URL so refresh preserves the reset state
  } 
}

function toggleCostChart() {
  state.showCostChart = !state.showCostChart;
  updateLayout();
  setTimeout(() => { if (costChartInst) costChartInst.resize(); if (perfChartInst) perfChartInst.resize(); }, 350);
}

function updateLayout() {
  const container = document.getElementById('charts-container');
  const costWrapper = document.getElementById('cost-chart-wrapper');
  const btnIcon = document.getElementById('btn-toggle-cost-icon');
  const btnText = document.getElementById('btn-toggle-cost-text');
  if (state.showCostChart) {
    container.classList.add('lg:grid-cols-2'); container.classList.remove('lg:grid-cols-1');
    costWrapper.classList.remove('hidden'); btnIcon.innerText = 'üëÅÔ∏è'; btnText.innerText = 'Cost';
  } else {
    container.classList.remove('lg:grid-cols-2'); container.classList.add('lg:grid-cols-1');
    costWrapper.classList.add('hidden'); btnIcon.innerText = 'üëÅÔ∏è'; btnText.innerText = 'Cost';
  }
}

// URL State
function getShareLink() { return window.location.href.split('#')[0] + '#' + btoa(encodeURIComponent(JSON.stringify(state))); }
function saveStateToUrl() {
  window.location.hash = btoa(encodeURIComponent(JSON.stringify(state)));
}

// Save current overrides as new defaults
function saveAsDefaults() {
  if (!confirm('Save current database values as new default settings? This will overwrite the original defaults and apply to all future sessions.')) {
    return;
  }
  
  // Save current overrides to localStorage
  try {
    localStorage.setItem('bmpTool_savedDefaults', JSON.stringify(state.overrides));
    alert('Defaults saved successfully! These values will now be used as the new defaults going forward.');
    
    // Visual feedback on button
    const btn = document.getElementById('save-defaults-btn');
    if (btn) {
      const originalText = btn.innerHTML;
      btn.innerHTML = '‚úì Saved!';
      btn.classList.add('bg-green-600', 'hover:bg-green-700');
      btn.classList.remove('bg-emerald-600', 'hover:bg-emerald-700');
      setTimeout(() => {
        btn.innerHTML = originalText;
        btn.classList.remove('bg-green-600', 'hover:bg-green-700');
        btn.classList.add('bg-emerald-600', 'hover:bg-emerald-700');
      }, 2000);
    }
  } catch (e) {
    alert('Error saving defaults: ' + e.message);
    console.error(e);
  }
}

// Load saved defaults from localStorage
function loadSavedDefaults() {
  try {
    const saved = localStorage.getItem('bmpTool_savedDefaults');
    if (saved) {
      const savedDefaults = JSON.parse(saved);
      // Merge saved defaults into state.overrides (these become the new baseline)
      // Deep merge to handle nested objects like specs and extra
      for (const bmpId in savedDefaults) {
        if (!state.overrides[bmpId]) state.overrides[bmpId] = {};
        if (savedDefaults[bmpId].specs) {
          state.overrides[bmpId].specs = { ...state.overrides[bmpId].specs, ...savedDefaults[bmpId].specs };
        }
        if (savedDefaults[bmpId].unitPrice !== undefined) {
          state.overrides[bmpId].unitPrice = savedDefaults[bmpId].unitPrice;
        }
        if (savedDefaults[bmpId].extra) {
          state.overrides[bmpId].extra = { ...state.overrides[bmpId].extra, ...savedDefaults[bmpId].extra };
        }
      }
      return true;
    }
  } catch (e) {
    console.error('Error loading saved defaults:', e);
  }
  return false;
}

function loadStateFromUrl() {
  if (window.location.hash && window.location.hash.length > 1) {
    try {
      const loaded = JSON.parse(decodeURIComponent(atob(window.location.hash.substring(1))));
      state = { ...INITIAL_STATE, ...loaded, inputs: { ...INITIAL_STATE.inputs, ...(loaded.inputs || {}) } };
      if (loaded.selectedScenarioIds) state.selectedScenarioIds = loaded.selectedScenarioIds;
      // Merge URL overrides with saved defaults (URL overrides take precedence for this session)
      if (loaded.overrides) {
        for (const bmpId in loaded.overrides) {
          if (!state.overrides[bmpId]) state.overrides[bmpId] = {};
          if (loaded.overrides[bmpId].specs) {
            state.overrides[bmpId].specs = { ...state.overrides[bmpId].specs, ...loaded.overrides[bmpId].specs };
          }
          if (loaded.overrides[bmpId].unitPrice !== undefined) {
            state.overrides[bmpId].unitPrice = loaded.overrides[bmpId].unitPrice;
          }
          if (loaded.overrides[bmpId].extra) {
            state.overrides[bmpId].extra = { ...state.overrides[bmpId].extra, ...loaded.overrides[bmpId].extra };
          }
        }
      }
    } catch (e) { console.error(e); }
  }
}
function copyShareLink() {
  const link = getShareLink();
  navigator.clipboard.writeText(link).then(() => {
    // Show temporary feedback
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<span>Copied!</span>';
    btn.classList.add('bg-green-600', 'hover:bg-green-700');
    btn.classList.remove('bg-slate-600', 'hover:bg-slate-700');
    setTimeout(() => {
      btn.innerHTML = originalText;
      btn.classList.remove('bg-green-600', 'hover:bg-green-700');
      btn.classList.add('bg-slate-600', 'hover:bg-slate-700');
    }, 2000);
  }).catch(err => {
    // Fallback: show link in prompt if clipboard API fails
    prompt('Copy this URL:', link);
  });
}

function printReport() {
  const printHeader = document.getElementById('print-header');
  const info = document.getElementById('print-info');
  const currentDate = new Date();
  const formattedDate = currentDate.toLocaleDateString('en-US', { 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
  
  // Update print header title (date is shown in print-info below)
  const titleElement = printHeader.querySelector('h1');
  if (titleElement) {
    titleElement.innerHTML = `Stormwater BMP Report`;
  }
  
  info.innerHTML = `<div><strong>Project:</strong> ${state.inputs.projectName || '-'}</div><div><strong>Address:</strong> ${state.inputs.projectAddress || '-'}</div><div><strong>Client:</strong> ${state.inputs.clientName || '-'}</div><div><strong>Report Generated:</strong> ${formattedDate}</div>`;
  const link = getShareLink();
  const linkElement = document.getElementById('print-link');
  const footer = document.getElementById('print-footer');
  
  // Ensure footer is at the absolute end of main content
  const main = document.querySelector('main');
  const dashboardDiv = main.querySelector('.max-w-7xl');
  if (footer && main) {
    // Remove footer from current position
    footer.remove();
    // Append to very end of main
    main.appendChild(footer);
  }
  
  // Create shortened display version: show just filename + last 20 characters
  const hashPart = link.split('#')[1] || '';
  const fileName = window.location.pathname.split('/').pop() || 'html-only.html';
  const shortDisplay = hashPart.length > 20 ? fileName + '#...' + hashPart.slice(-20) : fileName + '#' + hashPart;
  
  linkElement.innerText = shortDisplay;
  linkElement.href = link;
  linkElement.title = link; // Full URL in tooltip
  linkElement.style.fontFamily = 'monospace';
  linkElement.style.fontSize = '9px';
  window.location.hash = hashPart;
  
  // Open all details elements to show advanced specs in print
  const allDetails = document.querySelectorAll('details');
  allDetails.forEach(detail => {
    detail.setAttribute('open', '');
    detail.open = true;
    // Also force the content to be visible
    const content = detail.querySelector('div');
    if (content) {
      content.style.display = 'block';
      content.style.visibility = 'visible';
      content.style.opacity = '1';
    }
    // Force all nested elements within details to be visible
    const nested = detail.querySelectorAll('*');
    nested.forEach(el => {
      if (el.style) {
        if (el.style.display === 'none') el.style.display = '';
        if (el.style.visibility === 'hidden') el.style.visibility = '';
        if (el.style.opacity === '0') el.style.opacity = '1';
      }
    });
  });
  
  // Force detail panel to be visible in print and ensure all content is shown
  const detailPanel = document.getElementById('detail-panel');
  if (detailPanel) {
    detailPanel.style.display = 'block';
    detailPanel.style.visibility = 'visible';
    detailPanel.style.opacity = '1';
    // Force all nested elements to be visible
    const allNested = detailPanel.querySelectorAll('*');
    allNested.forEach(el => {
      if (el.style) {
        if (el.style.display === 'none') el.style.display = '';
        if (el.style.visibility === 'hidden') el.style.visibility = '';
        if (el.style.opacity === '0') el.style.opacity = '1';
      }
      // Also ensure summary elements don't hide content
      if (el.tagName === 'SUMMARY') {
        el.setAttribute('aria-expanded', 'true');
      }
    });
    // Explicitly open all details within detail panel
    const panelDetails = detailPanel.querySelectorAll('details');
    panelDetails.forEach(d => {
      d.setAttribute('open', '');
      d.open = true;
      d.removeAttribute('closed');
      // Force the summary to show as expanded
      const summary = d.querySelector('summary');
      if (summary) {
        summary.setAttribute('aria-expanded', 'true');
      }
      // Force all content divs to be visible
      const divs = d.querySelectorAll('div');
      divs.forEach(div => {
        div.style.display = 'block';
        div.style.visibility = 'visible';
        div.style.opacity = '1';
        // Remove any hidden classes
        div.classList.remove('hidden');
      });
      // Force all inputs and other elements to be visible
      const allElements = d.querySelectorAll('*');
      allElements.forEach(el => {
        if (el.style) {
          el.style.display = '';
          el.style.visibility = '';
          el.style.opacity = '';
        }
        el.classList.remove('hidden');
      });
    });
  }
  
  setTimeout(() => window.print(), 100);
}

let costChartInst = null, perfChartInst = null;
function updateCharts(allScenarios) {
  const data = allScenarios; 
  // Create shorter, more readable labels with wrapping for x-axis display
  const labels = data.map(d => {
    let name = d.name;
    name = name.replace(' (at grade)', '');
    name = name.replace(' / Crates', '');
    name = name.replace('Below Grade Tank', 'B.G. Tank');
    name = name.replace('On-Structure', 'On-Struct');
    name = name.replace('Purple-Roof (Vegetated)', 'Purple-Veg');
    name = name.replace('Purple-Roof (Pavers)', 'Purple-Pavers');
    name = name.replace('Underground ', 'U/G ');
    name = name.replace('Permeable Pavers', 'Perm Pavers');
    name = name.replace('Landscape Pond', 'Pond');
    name = name.replace('Blue Roof Cells 6"', 'Blue Roof 6"');
    // Simplify variant notation
    if (name.includes('4+1+2')) name = name.replace('4+1+2', '2"HC');
    if (name.includes('4+1+4')) name = name.replace('4+1+4', '4"HC');
    if (name.includes('P+1+2')) name = name.replace('P+1+2', '2"HC');
    if (name.includes('P+1+4')) name = name.replace('P+1+4', '4"HC');
    
    // Wrap long labels: split at spaces and insert line breaks for labels > 12 chars
    if (name.length > 12) {
      const words = name.split(' ');
      if (words.length > 1) {
        // Try to split into roughly equal parts
        const mid = Math.ceil(words.length / 2);
        name = words.slice(0, mid).join(' ') + '\n' + words.slice(mid).join(' ');
      }
    }
    return name;
  });
  const costs = data.map(d => Math.round(d.costDesigned) === Infinity ? 0 : Math.round(d.costDesigned));
  const rets = data.map(d => Math.round(d.retDesigned));
  const dets = data.map(d => Math.round(d.detDesigned));
  
  // Check if each scenario is selected (checkbox checked)
  const isSelected = (scenarioId) => state.selectedScenarioIds.some(sid => sid == scenarioId);
  
  const costColors = data.map(d => {
    if (!isSelected(d.id)) return 'rgba(226, 232, 240, 0.4)'; // Lighter grey if not selected
    return d.isViable ? 'rgba(99, 102, 241, 0.85)' : 'rgba(203, 213, 225, 0.6)';
  });
  const retColors = data.map(d => {
    if (!isSelected(d.id)) return 'rgba(226, 232, 240, 0.4)'; // Lighter grey if not selected
    return d.isViable ? 'rgba(14, 165, 233, 0.85)' : 'rgba(148, 163, 184, 0.6)';
  });
  const detColors = data.map(d => {
    if (!isSelected(d.id)) return 'rgba(226, 232, 240, 0.4)'; // Lighter grey if not selected
    return d.isViable ? 'rgba(99, 102, 241, 0.85)' : 'rgba(203, 213, 225, 0.6)';
  });
  
  // Add border colors for better definition
  const costBorderColors = data.map(d => {
    if (!isSelected(d.id)) return 'rgba(148, 163, 184, 0.3)';
    return d.isViable ? 'rgba(99, 102, 241, 1)' : 'rgba(148, 163, 184, 0.5)';
  });
  const retBorderColors = data.map(d => {
    if (!isSelected(d.id)) return 'rgba(148, 163, 184, 0.3)';
    return d.isViable ? 'rgba(14, 165, 233, 1)' : 'rgba(148, 163, 184, 0.5)';
  });
  const detBorderColors = data.map(d => {
    if (!isSelected(d.id)) return 'rgba(148, 163, 184, 0.3)';
    return d.isViable ? 'rgba(99, 102, 241, 1)' : 'rgba(148, 163, 184, 0.5)';
  });
  
  if (costChartInst) costChartInst.destroy();
  costChartInst = new Chart(document.getElementById('cost-chart'), {
    type: 'bar', 
    data: { 
      labels, 
      datasets: [{ 
        label: 'Cost ($)', 
        data: costs, 
        backgroundColor: costColors,
        borderColor: costBorderColors,
        borderWidth: 1.5,
        borderRadius: 8,
        borderSkipped: false
      }] 
    },
    options: { 
      responsive: true, 
      maintainAspectRatio: false,
      layout: {
        padding: {
          bottom: 20,
          top: 10,
          left: 5,
          right: 5
        }
      },
      plugins: { 
        legend: {display: false},
        tooltip: {
          enabled: true,
          backgroundColor: 'rgba(15, 23, 42, 0.9)',
          padding: 12,
          titleFont: { size: 12, weight: 'bold' },
          bodyFont: { size: 11 },
          borderColor: 'rgba(99, 102, 241, 0.5)',
          borderWidth: 1,
          cornerRadius: 8,
          displayColors: true,
          callbacks: {
            label: function(context) {
              return '$' + context.parsed.y.toLocaleString();
            }
          }
        }
      }, 
      scales: { 
        y: {
          beginAtZero: true,
          grid: {
            color: 'rgba(241, 245, 249, 0.8)',
            lineWidth: 1
          },
          border: {
            display: true,
            color: '#cbd5e1',
            width: 1
          },
          ticks: {
            font: { size: 10 },
            color: '#64748b',
            padding: 8
          }
        },
        x: { 
          grid: {
            display: true,
            color: 'rgba(148, 163, 184, 0.8)',
            lineWidth: 1,
            drawOnChartArea: true,
            drawTicks: true
          },
          border: {
            display: true,
            color: '#94a3b8',
            width: 1
          },
          ticks: { 
            font: { size: 10, weight: '500' },
            color: '#475569',
            maxRotation: 45,
            minRotation: 45,
            autoSkip: false,
            padding: 8
          }
        } 
      } 
    }
  });
  
  if (perfChartInst) perfChartInst.destroy();
  // Calculate y-axis max to be 12.5% above the highest target (middle of 10-15% range)
  const maxTarget = Math.max(state.inputs.targetDetentionCF, state.inputs.targetRetentionCF);
  const yAxisMax = maxTarget * 1.125; // 12.5% taller
  
  perfChartInst = new Chart(document.getElementById('perf-chart'), {
    type: 'bar', 
    data: { 
      labels, 
      datasets: [
        { 
          label: 'Retention', 
          data: rets, 
          backgroundColor: retColors,
          borderColor: retBorderColors,
          borderWidth: 1.5,
          borderRadius: 6,
          borderSkipped: false
        }, 
        { 
          label: 'Detention', 
          data: dets, 
          backgroundColor: detColors,
          borderColor: detBorderColors,
          borderWidth: 1.5,
          borderRadius: 6,
          borderSkipped: false
        }
      ] 
    },
    options: { 
       responsive: true, 
       maintainAspectRatio: false,
       layout: {
         padding: {
           bottom: 20,
           top: 10,
           left: 5,
           right: 5
         }
       },
       onHover: (event, activeElements) => {
         event.native.target.style.cursor = activeElements.length > 0 ? 'ns-resize' : 'default';
       },
       scales: { 
         y: { 
           beginAtZero: true, 
           max: yAxisMax, 
           grid: { 
             color: 'rgba(241, 245, 249, 0.8)',
             lineWidth: 1
           },
           border: {
             display: true,
             color: '#cbd5e1',
             width: 1
           },
           ticks: {
             font: { size: 10 },
             color: '#64748b',
             padding: 8
           },
           title: {
             display: true,
             text: 'Volume (CF)',
             font: { size: 12, weight: 'bold' },
             color: '#475569',
             padding: { top: 5, bottom: 10 }
           }
         }, 
         x: { 
           grid: {
             display: true,
             color: 'rgba(148, 163, 184, 0.8)',
             lineWidth: 1,
             drawOnChartArea: true,
             drawTicks: true
           },
           border: {
             display: true,
             color: '#94a3b8',
             width: 1
           },
           ticks: { 
             font: { size: 10, weight: '500' },
             color: '#475569',
             maxRotation: 45,
             minRotation: 45,
             autoSkip: false,
             padding: 8
           }
         } 
       },
       plugins: {
         legend: {
           display: false
         },
         tooltip: { 
           enabled: true, 
           mode: 'index', 
           intersect: false, 
           position: 'average', 
           yAlign: 'bottom', 
           backgroundColor: 'rgba(15, 23, 42, 0.9)',
           padding: 12,
           titleFont: { size: 12, weight: 'bold' },
           bodyFont: { size: 11 },
           borderColor: 'rgba(14, 165, 233, 0.5)',
           borderWidth: 1,
           cornerRadius: 8,
           caretPadding: 15, 
           displayColors: true, 
           callbacks: { 
             footer: (items) => { 
               const total = items.reduce((a, b) => a + b.parsed.y, 0); 
               const c = costs[items[0].dataIndex]; 
               return ['Total: ' + Math.round(total).toLocaleString() + ' CF', 'Cost: ' + (c===0?'-':'$'+c.toLocaleString())]; 
             } 
           } 
         },
         annotation: { 
           annotations: {
             line1: { 
               type: 'line', 
               yMin: state.inputs.targetDetentionCF, 
               yMax: state.inputs.targetDetentionCF, 
               borderColor: '#6366f1', 
               borderDash: [4,4], 
               borderWidth: 3.75,
               shadowBlur: 2,
               shadowColor: 'rgba(99, 102, 241, 0.3)',
               label: { 
                 content: 'Target Det', 
                 enabled: true, 
                 position: 'end',
                 backgroundColor: 'rgba(99, 102, 241, 0.9)',
                 color: 'white',
                 font: { size: 10, weight: 'bold' },
                 padding: 4,
                 borderRadius: 4
               } 
             },
             line2: { 
               type: 'line', 
               yMin: state.inputs.targetRetentionCF + (state.inputs.targetDetentionCF === state.inputs.targetRetentionCF ? 0.5 : 0), 
               yMax: state.inputs.targetRetentionCF + (state.inputs.targetDetentionCF === state.inputs.targetRetentionCF ? 0.5 : 0), 
               borderColor: '#0ea5e9', 
               borderDash: [8,4], 
               borderWidth: 2.5,
               shadowBlur: 2,
               shadowColor: 'rgba(14, 165, 233, 0.3)',
               label: { 
                 content: 'Target Ret', 
                 enabled: true, 
                 position: 'end',
                 backgroundColor: 'rgba(14, 165, 233, 0.9)',
                 color: 'white',
                 font: { size: 10, weight: 'bold' },
                 padding: 4,
                 borderRadius: 4
               } 
             }
           } 
         }
       }
    }
  });
  
  // Add drag functionality to chart bars
  setupChartDragHandlers(perfChartInst, data, yAxisMax);
}

function setupChartDragHandlers(chart, data, yAxisMax) {
  const canvas = chart.canvas;
  let isDragging = false;
  let dragBarIndex = -1;
  let lastUpdateTime = 0;
  const UPDATE_THROTTLE_MS = 200; // Simpler throttle - update every 200ms
  
  function getValueFromYPosition(yPos, chartArea, yScale) {
    const relativeY = chartArea.bottom - yPos;
    const pixelRange = chartArea.bottom - chartArea.top;
    const valueRange = yScale.max - yScale.min;
    const value = yScale.min + (relativeY / pixelRange) * valueRange;
    return Math.max(0, Math.min(yAxisMax, value));
  }
  
  function updateBarFromDrag(newTotalCF, barIndex) {
    const now = Date.now();
    if (now - lastUpdateTime < UPDATE_THROTTLE_MS) return;
    lastUpdateTime = now;
    
    const bmp = data[barIndex];
    if (!bmp || bmp.grossDesignedArea === Infinity) return;
    
    // Get the BMP's capacity and specs
    const profile = getRegulationProfile();
    const fullSpec = getSpec(bmp.id);
    const capacity = calculateCapacity(bmp.id, fullSpec, profile);
    
    // Calculate total capacity per SF (retention + detention)
    const totalCfPerSf = capacity.cfRetPerSf + capacity.cfDetPerSf;
    if (totalCfPerSf <= 0) return;
    
    // Work backwards: newTotalCF = netArea * totalCfPerSf
    // netArea = grossArea * (1 - spaceLoss)
    // So: newTotalCF = grossArea * (1 - spaceLoss) * totalCfPerSf
    // Therefore: grossArea = newTotalCF / ((1 - spaceLoss) * totalCfPerSf)
    const netAreaNeeded = newTotalCF / totalCfPerSf;
    const grossAreaNeeded = netAreaNeeded / (1 - fullSpec.specs.spaceLoss);
    
    // Clamp to eligible area
    const newArea = Math.max(0, Math.min(bmp.eligibleArea, Math.round(grossAreaNeeded)));
    
    // Only update if the value actually changed significantly
    const currentArea = state.overrides[bmp.id]?.manualArea ?? bmp.grossDesignedArea;
    if (Math.abs(newArea - currentArea) < 5) return; // Increased threshold to reduce updates
    
    // Update the override
    updateManualArea(bmp.id, newArea);
  }
  
  function getBarIndexAtPosition(x, y) {
    const chartArea = chart.chartArea;
    if (x < chartArea.left || x > chartArea.right || y < chartArea.top || y > chartArea.bottom) {
      return -1;
    }
    
    // Calculate which bar based on x position
    const barWidth = (chartArea.right - chartArea.left) / data.length;
    const barIndex = Math.floor((x - chartArea.left) / barWidth);
    
    // Check if y is within the bar height
    if (barIndex >= 0 && barIndex < data.length) {
      const bmp = data[barIndex];
      const totalCF = bmp.retDesigned + bmp.detDesigned;
      const yScale = chart.scales.y;
      const barTop = chartArea.bottom - ((totalCF - yScale.min) / (yScale.max - yScale.min)) * (chartArea.bottom - chartArea.top);
      if (y >= barTop && y <= chartArea.bottom) {
        return barIndex;
      }
    }
    return -1;
  }
  
  canvas.addEventListener('mousedown', (e) => {
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    
    const barIndex = getBarIndexAtPosition(x, y);
    if (barIndex >= 0) {
      isDragging = true;
      dragBarIndex = barIndex;
      canvas.style.cursor = 'ns-resize';
      e.preventDefault();
    }
  });
  
  canvas.addEventListener('mousemove', (e) => {
    if (!isDragging || dragBarIndex < 0) {
      // Update cursor on hover
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      const barIndex = getBarIndexAtPosition(x, y);
      canvas.style.cursor = barIndex >= 0 ? 'ns-resize' : 'default';
      return;
    }
    
    const rect = canvas.getBoundingClientRect();
    const y = e.clientY - rect.top;
    const chartArea = chart.chartArea;
    const yScale = chart.scales.y;
    
    const newTotalCF = getValueFromYPosition(y, chartArea, yScale);
    updateBarFromDrag(newTotalCF, dragBarIndex);
  });
  
  canvas.addEventListener('mouseup', () => {
    if (isDragging) {
      isDragging = false;
      dragBarIndex = -1;
      canvas.style.cursor = 'default';
    }
  });
  
  canvas.addEventListener('mouseleave', () => {
    if (isDragging) {
      isDragging = false;
      dragBarIndex = -1;
      canvas.style.cursor = 'default';
    }
  });
}

function renderSidebar() {
  const c = document.getElementById('sidebar-content');
  const i = state.inputs;
  
  c.innerHTML = `
    <div class="space-y-[8.67px] bg-white p-[8.67px] rounded-lg border border-slate-200 shadow-sm hover:shadow transition-shadow">
      <label class="text-xs font-semibold text-slate-800 uppercase tracking-wide">Project Details</label>
      <input type="text" placeholder="Project Name" value="${i.projectName}" onchange="updateInput('projectName', this.value)" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm mb-[5.78px] font-normal focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all bg-white">
      <input type="text" placeholder="Address" value="${i.projectAddress}" onchange="updateInput('projectAddress', this.value)" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm mb-[5.78px] font-normal focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all bg-white">
      <input type="text" placeholder="Client Name" value="${i.clientName}" onchange="updateInput('clientName', this.value)" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm font-normal focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all bg-white">
    </div>

    <div class="space-y-[8.67px] bg-gradient-to-br from-slate-50 to-white p-[8.67px] rounded-lg border border-slate-200 shadow-sm hover:shadow transition-shadow">
      <div class="flex items-center justify-between mb-[5.78px]">
        <label class="text-xs font-semibold text-slate-800 uppercase tracking-wide">Regulation Basis</label>
      </div>
      <div class="flex flex-col gap-[5.78px]">
        ${Object.values(REGULATION_PROFILES).map(profile => `
          <label class="flex items-center gap-2 text-sm cursor-pointer tooltip-container">
            <input type="radio" name="regProfile" value="${profile.id}" ${state.regulationProfileId === profile.id ? 'checked' : ''} onchange="setProfile('${profile.id}')" class="text-indigo-600">
            <span>${profile.label}</span>
            <span class="tooltip-text">
              <strong>${profile.label}:</strong><br>
              ‚Ä¢ Soil Retention: ${(profile.defaults.soilRetentionPct * 100).toFixed(0)}%<br>
              ‚Ä¢ NMW Retention: ${(profile.defaults.nmwRetentionPct * 100).toFixed(0)}%<br>
              ‚Ä¢ Honeycomb Void: ${(profile.defaults.honeycombVoidPct * 100).toFixed(0)}%<br>
              ${profile.rules.nmwRetentionRequiresMinSoilCoverIn > 0 ? `‚Ä¢ NMW requires ‚â•${profile.rules.nmwRetentionRequiresMinSoilCoverIn}" soil cover` : '‚Ä¢ No minimum soil cover requirement'}
            </span>
          </label>
        `).join('')}
      </div>
    </div>

    <div class="space-y-[11.56px]">
      <div class="space-y-[5.78px] bg-gradient-to-br from-white to-indigo-50/30 p-[8.67px] rounded-lg border-2 border-indigo-200 shadow-sm hover:shadow transition-shadow">
        <label class="text-sm font-semibold text-slate-800">Targets (CF)</label>
        <div class="grid grid-cols-2 gap-[5.78px]">
          <div>
            <div class="flex items-center gap-1 mb-1">
              <input type="checkbox" ${i.detentionNeeded ? 'checked' : ''} onchange="updateInput('detentionNeeded', this.checked)" class="w-3 h-3 rounded border-indigo-300 text-indigo-600 focus:ring-indigo-500">
              <span class="text-xs text-indigo-600 font-semibold">Detention</span>
            </div>
            <input type="number" value="${i.targetDetentionCF}" onchange="updateInput('targetDetentionCF', this.value)" class="w-full px-3 py-2 border-2 border-indigo-300 rounded-lg text-sm font-normal bg-indigo-50/30 focus:bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/20 transition-all">
          </div>
          <div>
            <div class="flex items-center gap-1 mb-[2.89px]">
              <input type="checkbox" ${i.retentionNeeded ? 'checked' : ''} onchange="updateInput('retentionNeeded', this.checked)" class="w-3 h-3 rounded border-sky-300 text-sky-600 focus:ring-sky-500">
              <span class="text-xs text-sky-600 font-semibold">Retention</span>
            </div>
            <input type="number" value="${i.targetRetentionCF}" onchange="updateInput('targetRetentionCF', this.value)" class="w-full px-3 py-2 border-2 border-sky-300 rounded-lg text-sm font-normal bg-sky-50/30 focus:bg-white focus:border-sky-500 focus:ring-2 focus:ring-sky-500/20 transition-all">
          </div>
        </div>
      </div>

      <div class="space-y-[5.78px] bg-gradient-to-br from-green-50 to-emerald-50/50 p-[8.67px] rounded-lg border border-green-200 shadow-sm hover:shadow transition-shadow">
        <div class="flex items-center justify-between mb-[5.78px]">
          <label class="text-xs font-semibold text-slate-800 uppercase tracking-wide">At-Grade Areas (sf)</label>
          <div class="text-xs font-semibold text-green-700 bg-green-100 px-2 py-0.5 rounded shadow-sm">Total: ${(i.perviousLandscapingUsable + i.imperviousVehicularPavement + i.imperviousPedestrianPavement + i.perviousTreeCoverNonUsable).toLocaleString()} sf</div>
        </div>
        <div class="space-y-[5.78px]">
           <div><span class="text-xs text-slate-600 block mb-1 font-medium">Usable Landscape (pond/cell/tank)</span><input type="number" value="${i.perviousLandscapingUsable}" onchange="updateInput('perviousLandscapingUsable', this.value)" class="w-full px-3 py-2 border border-green-300 rounded-lg text-sm bg-white font-normal focus:ring-2 focus:ring-green-500/20 focus:border-green-400 transition-all"></div>
           <div><span class="text-xs text-slate-600 block mb-1 font-medium">Vehicular Pavement (cell/tank)</span><input type="number" value="${i.imperviousVehicularPavement}" onchange="updateInput('imperviousVehicularPavement', this.value)" class="w-full px-3 py-2 border border-green-300 rounded-lg text-sm bg-white font-normal focus:ring-2 focus:ring-green-500/20 focus:border-green-400 transition-all"></div>
           <div><span class="text-xs text-slate-600 block mb-1 font-medium">Pedestrian Pavement (paver/cell/tank)</span><input type="number" value="${i.imperviousPedestrianPavement}" onchange="updateInput('imperviousPedestrianPavement', this.value)" class="w-full px-3 py-2 border border-green-300 rounded-lg text-sm bg-white font-normal focus:ring-2 focus:ring-green-500/20 focus:border-green-400 transition-all"></div>
           <div><span class="text-xs text-slate-600 block mb-1 font-medium">Tree Cover / Non-Usable (none)</span><input type="number" value="${i.perviousTreeCoverNonUsable}" onchange="updateInput('perviousTreeCoverNonUsable', this.value)" class="w-full px-3 py-2 border border-green-300 rounded-lg text-sm bg-white font-normal focus:ring-2 focus:ring-green-500/20 focus:border-green-400 transition-all"></div>
        </div>
      </div>

      <div class="space-y-[6.8px] bg-slate-100 p-[10.2px] rounded-lg border border-slate-300">
        <div class="flex items-center justify-between mb-[5.78px]">
          <label class="text-xs font-semibold text-slate-700 uppercase">On-Structure Areas (sf)</label>
          <div class="text-xs font-semibold text-slate-700 bg-slate-200 px-2 py-0.5 rounded">Total: ${(i.flatDeckOnStructureArea + i.slopedRoofArea + i.paversOnStructureArea + i.imperviousCAUntreated).toLocaleString()} sf</div>
        </div>
        <div class="space-y-[6.8px]">
           <div><span class="text-xs text-slate-600 block mb-[2.89px] font-medium">Flat Deck/Plaza (blue/tank/purple)</span><input type="number" value="${i.flatDeckOnStructureArea}" onchange="updateInput('flatDeckOnStructureArea', this.value)" class="w-full px-3 py-2 border border-slate-400 rounded-lg text-sm bg-white font-normal focus:ring-2 focus:ring-slate-500/20 focus:border-slate-500 transition-all"></div>
           <div><span class="text-xs text-slate-600 block mb-1 font-medium">Sloped Roof (green/purple/sponge)</span><input type="number" value="${i.slopedRoofArea}" onchange="updateInput('slopedRoofArea', this.value)" class="w-full px-3 py-2 border border-slate-400 rounded-lg text-sm bg-white font-normal focus:ring-2 focus:ring-slate-500/20 focus:border-slate-500 transition-all"></div>
           <div><span class="text-xs text-slate-600 block mb-1 font-medium">Pavers on Structure (purple-paver)</span><input type="number" value="${i.paversOnStructureArea}" onchange="updateInput('paversOnStructureArea', this.value)" class="w-full px-3 py-2 border border-slate-400 rounded-lg text-sm bg-white font-normal focus:ring-2 focus:ring-slate-500/20 focus:border-slate-500 transition-all"></div>
           <div><span class="text-xs text-slate-600 block mb-1 font-medium">CA/Untreated (contributing only)</span><input type="number" value="${i.imperviousCAUntreated}" onchange="updateInput('imperviousCAUntreated', this.value)" class="w-full px-3 py-2 border border-slate-400 rounded-lg text-sm bg-white font-normal focus:ring-2 focus:ring-slate-500/20 focus:border-slate-500 transition-all"></div>
        </div>
      </div>

      <div class="space-y-[5.78px] bg-gradient-to-br from-orange-50 to-amber-50/50 p-[8.67px] rounded-lg border border-orange-200 shadow-sm hover:shadow transition-shadow">
        <label class="text-xs font-semibold text-slate-800 uppercase tracking-wide block mb-[5.78px]">Site Conditions</label>
        <div class="flex flex-col gap-[2.89px]">
          <label class="flex items-center gap-2 text-sm cursor-pointer py-1">
            <input type="checkbox" ${i.greenRoofAlreadyInScope ? 'checked' : ''} onchange="updateInput('greenRoofAlreadyInScope', this.checked)" class="text-indigo-600 rounded border-slate-300 focus:ring-indigo-500">
            <span class="text-slate-600 font-normal">Green Roof in Scope</span>
          </label>
          <label class="flex items-center gap-2 text-sm cursor-pointer py-1">
             <input type="checkbox" ${i.hasUndergroundUtilities ? 'checked' : ''} onchange="updateInput('hasUndergroundUtilities', this.checked)" class="text-red-500 rounded border-slate-300 focus:ring-red-500">
             <span class="text-slate-600 font-normal">Utilities Conflict</span>
          </label>
          <label class="flex items-center gap-2 text-sm cursor-pointer py-1">
             <input type="checkbox" ${i.hasHighWaterTable ? 'checked' : ''} onchange="updateInput('hasHighWaterTable', this.checked)" class="text-red-500 rounded border-slate-300 focus:ring-red-500">
             <span class="text-slate-600 font-normal">High Water Table</span>
          </label>
          <label class="flex items-center gap-2 text-sm cursor-pointer py-1">
             <input type="checkbox" ${i.hasContaminatedSoil ? 'checked' : ''} onchange="updateInput('hasContaminatedSoil', this.checked)" class="text-red-500 rounded border-slate-300 focus:ring-red-500">
             <span class="text-slate-600 font-normal">Contaminated Soil</span>
          </label>
        </div>
      </div>
    </div>
    
    <button onclick="openDatabaseModal()" class="w-full p-[8.67px] bg-indigo-50 border border-indigo-200 rounded-lg text-sm font-medium text-indigo-700 hover:bg-indigo-100 transition-colors flex items-center justify-center gap-[5.78px]">
      <span>üìä</span> Open Database (BMP Library & Regulation Basis)
    </button>
  `;
}

function renderDashboard(data) {
  const m = document.getElementById('metrics-container');
  const i = state.inputs;
  
  // Update asterisk legend
  const legend = document.getElementById('asterisk-legend');
  if (legend) {
    legend.innerHTML = (i.greenRoofAlreadyInScope || i.paversOnStructureArea > 0 || i.paversOnPedestals) 
      ? '<span class="font-bold">*</span> = Delta cost only (traditional system in scope)' 
      : '';
  }
  
  // Calculate totals
  const totalRoofArea = i.flatDeckOnStructureArea + i.slopedRoofArea + i.paversOnStructureArea + i.imperviousCAUntreated;
  const totalAtGradeArea = i.perviousLandscapingUsable + i.imperviousVehicularPavement + i.imperviousPedestrianPavement + i.perviousTreeCoverNonUsable;
  
  // Build site conditions list (only blocking/adverse conditions for main display)
  const siteConditions = [];
  if (i.greenRoofAlreadyInScope) siteConditions.push({ name: 'Green Roof in Scope', type: 'info' });
  if (i.hasUndergroundUtilities) siteConditions.push({ name: 'Utilities Conflict', type: 'blocking' });
  if (i.hasHighWaterTable) siteConditions.push({ name: 'High Water Table', type: 'blocking' });
  if (i.hasContaminatedSoil) siteConditions.push({ name: 'Contaminated Soil', type: 'blocking' });
  
  // Display site conditions if any are checked
  const conditionsDisplay = document.getElementById('site-conditions-display');
  if (conditionsDisplay) {
    if (siteConditions.length > 0) {
      conditionsDisplay.innerHTML = `
        <div class="bg-gradient-to-br from-orange-50 to-amber-50/50 p-2.5 rounded-lg border border-orange-200 shadow-sm hover:shadow-md transition-shadow">
          <div class="flex items-center gap-2 flex-wrap">
            <div class="text-xs font-semibold text-slate-800 uppercase tracking-wide">Site Conditions:</div>
            <div class="flex flex-wrap gap-1.5">
              ${siteConditions.map(cond => `
                <span class="inline-flex items-center gap-1 px-2 py-0.5 bg-white border ${cond.type === 'blocking' ? 'border-red-300' : 'border-orange-300'} rounded-md text-xs font-medium ${cond.type === 'blocking' ? 'text-red-700' : 'text-slate-700'}">
                  <span class="${cond.type === 'blocking' ? 'text-red-600' : 'text-orange-600'}">‚óè</span> ${cond.name}
                </span>
              `).join('')}
            </div>
          </div>
        </div>
      `;
    } else {
      conditionsDisplay.innerHTML = '';
    }
  }
  
  m.innerHTML = `
    <div class="bg-slate-200 p-3 rounded-xl border border-slate-400 shadow-sm hover:shadow-md transition-shadow"><div class="text-[10px] text-slate-700 font-semibold uppercase tracking-wide">Total Site Area</div><div class="text-xl font-semibold text-slate-800">${data.areas.contributingTotalSiteArea.toLocaleString()} <span class="text-xs font-normal text-slate-600">sf</span></div></div>
    <div class="bg-gradient-to-br from-green-100 to-emerald-100 p-3 rounded-xl border border-green-300 shadow-sm hover:shadow-md transition-shadow"><div class="text-[10px] text-slate-700 font-semibold uppercase tracking-wide">Total At-Grade Area</div><div class="text-xl font-semibold text-slate-800">${totalAtGradeArea.toLocaleString()} <span class="text-xs font-normal text-slate-600">sf</span></div></div>
    <div class="bg-slate-200 p-3 rounded-xl border border-slate-400 shadow-sm hover:shadow-md transition-shadow"><div class="text-[10px] text-slate-700 font-semibold uppercase tracking-wide">Total Roof Area</div><div class="text-xl font-semibold text-slate-800">${totalRoofArea.toLocaleString()} <span class="text-xs font-normal text-slate-600">sf</span></div></div>
    <div class="bg-gradient-to-br from-sky-100 to-white p-3 rounded-xl border border-sky-300 shadow-sm hover:shadow-md transition-shadow"><div class="text-[10px] text-sky-800 font-semibold uppercase tracking-wide">Target Retention</div><div class="text-xl font-semibold text-sky-800">${state.inputs.targetRetentionCF.toLocaleString()} <span class="text-xs font-normal text-sky-700">CF</span></div></div>
    <div class="bg-gradient-to-br from-indigo-100 to-white p-3 rounded-xl border border-indigo-300 shadow-sm hover:shadow-md transition-shadow"><div class="text-[10px] text-indigo-800 font-semibold uppercase tracking-wide">Target Detention</div><div class="text-xl font-semibold text-indigo-800">${state.inputs.targetDetentionCF.toLocaleString()} <span class="text-xs font-normal text-indigo-700">CF</span></div></div>
  `;
  
  const tbody = document.getElementById('scenario-table-body');
  tbody.innerHTML = data.results.map(r => {
    const isSelected = state.selectedScenarioIds.some(sid => sid == r.id);
    const costStr = r.costDesigned === Infinity ? '-' : '$' + Math.round(r.costDesigned).toLocaleString();
    const landStr = r.grossDesignedArea === Infinity ? '-' : Math.round(r.grossDesignedArea).toLocaleString();
    const availStr = Math.round(r.eligibleArea).toLocaleString();
    const totalStorage = r.retDesigned + r.detDesigned;
    
    // Check if asterisk needed (delta cost indicator)
    const isPurpleVegetated = (r.id == 10 || r.id == '10B');
    const isPurplePavers = (r.id == 11 || r.id == '11B');
    const needsAsterisk = (isPurpleVegetated && state.inputs.greenRoofAlreadyInScope) || 
                          (isPurplePavers && state.inputs.paversOnStructureArea > 0);
    const asteriskNote = needsAsterisk ? ' <span class="text-amber-600 font-bold" title="Traditional system already in scope - only delta (upgrade) cost applies">*</span>' : '';
    
    // Shorten strategy name for table display (less aggressive shortening to show more)
    let shortName = r.name;
    shortName = shortName.replace(' (at grade)', '');
    shortName = shortName.replace(' / Crates', '');
    shortName = shortName.replace('Below Grade Tank', 'Below Grade Tank');
    shortName = shortName.replace('On-Structure', 'On-Structure');
    shortName = shortName.replace('Purple-Roof (Vegetated)', 'Purple-Roof (Veg)');
    shortName = shortName.replace('Purple-Roof (Pavers)', 'Purple-Roof (Pavers)');
    shortName = shortName.replace('Underground ', 'Underground ');
    if (shortName.includes('4+1+2')) shortName = shortName.replace('4+1+2', '4+1+2');
    if (shortName.includes('4+1+4')) shortName = shortName.replace('4+1+4', '4+1+4');
    if (shortName.includes('P+1+2')) shortName = shortName.replace('P+1+2', 'P+1+2');
    if (shortName.includes('P+1+4')) shortName = shortName.replace('P+1+4', 'P+1+4');
    
    return `
      <tr onclick="selectScenario('${r.id}')" class="cursor-pointer transition-all ${isSelected ? 'bg-indigo-50/90 border-l-4 border-indigo-500 shadow-sm' : 'hover:bg-slate-50/80 border-l-4 border-transparent hover:border-l-indigo-200'} ${!r.isViable ? 'opacity-60' : ''}">
        <td class="px-1.5 py-1 text-center">
           <input type="checkbox" ${isSelected ? 'checked' : ''} class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500 h-3 w-3 pointer-events-none">
        </td>
        <td class="px-1.5 py-1 text-center">
          ${r.isViable ? `<span class="text-emerald-500 font-semibold text-sm" title="Viable">&#10003;</span>` : `<span class="text-red-500 font-semibold text-sm" title="Not Viable">&#10007;</span>`}
        </td>
        <td class="px-2 py-1 font-normal text-xs text-slate-700 min-w-[250px] max-w-[350px]" title="${r.name}">
           <span class="image-tooltip-container">
             ${r.id}. ${shortName}${asteriskNote}
             ${BMP_IMAGES[r.id] ? `<span class="image-tooltip"><img src="${BMP_IMAGES[r.id]}" alt="${r.name}" onerror="this.parentElement.parentElement.style.display='none'"></span>` : ''}
           </span>
           ${r.warnings.length > 0 ? `<span class="icon-alert text-amber-500 ml-0.5 text-[10px]" title="${r.warnings.join(', ')}"></span>` : ''}
        </td>
        <td class="px-1.5 py-1 text-right font-mono text-xs text-slate-600">${costStr}</td>
        <td class="px-1.5 py-1 text-right font-mono text-xs text-slate-400">${availStr}</td>
        <td class="px-1.5 py-1 text-right" onclick="event.stopPropagation()">
           <input type="number" value="${Math.round(r.grossDesignedArea)}" onchange="updateManualArea('${r.id}', this.value)" class="w-16 px-0.5 py-0.5 text-right font-mono text-xs border-2 border-indigo-300 hover:border-indigo-400 focus:border-indigo-500 rounded bg-indigo-50/50 hover:bg-indigo-50 focus:bg-white transition-colors outline-none cursor-text" placeholder="-" title="Click to edit area used" id="input-used-${r.id}">
        </td>
        <td class="px-1.5 py-1 text-right font-mono text-xs text-sky-600">${Math.round(r.retDesigned).toLocaleString()}</td>
        <td class="px-1.5 py-1 text-right font-mono text-xs text-indigo-600">${Math.round(r.detDesigned).toLocaleString()}</td>
        <td class="px-1.5 py-1 text-right font-mono text-xs font-normal text-slate-700">${Math.round(totalStorage).toLocaleString()}</td>
      </tr>
    `;
  }).join('');
  
  updateCharts(data.results);
  renderDetail(data);
}

function renderDetail(data) {
  const panel = document.getElementById('detail-panel');
  let selection = data.results.filter(r => state.selectedScenarioIds.some(sid => sid == r.id));
  
  // Show empty state if no strategies are selected
  if (selection.length === 0) {
    panel.innerHTML = `
      <div class="p-5 border-b border-slate-700 bg-slate-800/50">
        <div class="text-xs text-indigo-400 font-semibold uppercase tracking-wider mb-1">Selected Strategy</div>
        <h2 class="text-xl font-semibold text-white leading-tight">No Strategy Selected</h2>
      </div>
      <div class="flex-1 overflow-y-auto custom-scrollbar p-5 flex items-center justify-center">
        <div class="text-center text-slate-400 max-w-xs">
          <div class="text-5xl mb-4 opacity-50">\u2610</div>
          <div class="text-sm font-normal mb-2 text-slate-300">Select strategies from the table</div>
          <div class="text-xs text-slate-500 leading-relaxed font-normal">Check one or more BMPs using the checkboxes to see combined totals for Retention and Detention targets</div>
        </div>
      </div>
    `;
    return;
  }
  
  const totalCost = selection.reduce((sum, r) => sum + r.costDesigned, 0);
  const totalRet = selection.reduce((sum, r) => sum + r.retDesigned, 0);
  const totalDet = selection.reduce((sum, r) => sum + r.detDesigned, 0);
  const targetRet = state.inputs.targetRetentionCF;
  const targetDet = state.inputs.targetDetentionCF;
  const metRet = targetRet <= 0 || totalRet >= targetRet * 0.99;
  const metDet = targetDet <= 0 || totalDet >= targetDet * 0.99;
  const isCombinedViable = metRet && metDet; 
  
  let html = `
    <div class="p-5 border-b border-slate-600 bg-gradient-to-r from-slate-800/60 to-slate-900/60 flex justify-between items-start">
      <div><div class="text-xs text-indigo-300 font-semibold uppercase tracking-wider mb-1">Selected Strategy (${selection.length})</div><h2 class="text-xl font-semibold text-white leading-tight">${selection.length > 1 ? 'Combined System' : `<span class="image-tooltip-container">${selection[0].name}${BMP_IMAGES[selection[0].id] ? `<span class="image-tooltip"><img src="${BMP_IMAGES[selection[0].id]}" alt="${selection[0].name}" onerror="this.parentElement.parentElement.style.display='none'"></span>` : ''}</span>`}</h2></div>
      <div class="text-right"><div class="text-2xl font-semibold text-emerald-400">$${Math.round(totalCost).toLocaleString()}</div><div class="text-xs text-slate-300 font-medium">Total Est. Cost</div></div>
    </div>
    <div class="flex-1 overflow-y-auto custom-scrollbar p-5 space-y-6">
       <div class="p-4 rounded-lg border-2 ${isCombinedViable ? 'bg-gradient-to-br from-emerald-900/25 to-emerald-800/15 border-emerald-400/40 shadow-sm' : 'bg-gradient-to-br from-amber-900/25 to-amber-800/15 border-amber-400/40 shadow-sm'}">
          <div class="flex items-center gap-3 mb-3">
            ${isCombinedViable 
              ? '<div class="text-5xl text-emerald-400 font-bold drop-shadow-sm">&#10003;</div>' 
              : '<div class="text-5xl text-red-400 font-bold drop-shadow-sm">&#10007;</div>'
            }
            <div class="flex-1">
              <div class="font-semibold ${isCombinedViable ? 'text-emerald-300' : 'text-amber-300'} text-lg">${isCombinedViable ? 'Targets Met' : 'Targets Not Fully Met'}</div>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4 text-sm">
             <div><span class="text-slate-400 text-xs block">Retention <span class="${metRet ? 'text-emerald-400' : 'text-red-400'} font-bold">${metRet ? '‚úì' : '‚úó'}</span></span><span class="${metRet ? 'text-sky-400' : 'text-red-400'} font-mono font-semibold">${Math.round(totalRet).toLocaleString()} / ${targetRet} CF</span></div>
             <div><span class="text-slate-400 text-xs block">Detention <span class="${metDet ? 'text-emerald-400' : 'text-red-400'} font-bold">${metDet ? '‚úì' : '‚úó'}</span></span><span class="${metDet ? 'text-indigo-400' : 'text-red-400'} font-mono font-semibold">${Math.round(totalDet).toLocaleString()} / ${targetDet} CF</span></div>
          </div>
       </div>
       <div class="space-y-4">
  `;
  
  html += selection.map(sel => {
    const specRows = Object.entries(sel.fullSpec.specs).map(([key, val]) => {
        let unit = ''; const k = key.toLowerCase();
        if (k.includes('depth') || k.includes('freeboard')) unit = '(in)'; else if (k.includes('porosity') || k.includes('ratio') || k.includes('pct') || k.includes('loss')) unit = '(%)';
        const step = unit === '(%)' ? 0.01 : 0.1;
        return `<div class="flex justify-between items-center py-1 border-b border-slate-700/50"><label class="text-xs text-slate-400 capitalize">${key.replace(/([A-Z])/g, ' $1')} <span class="text-[10px] text-slate-500">${unit}</span></label><input type="number" step="${step}" value="${val}" readonly disabled class="w-16 bg-slate-700/50 border border-slate-600 rounded px-2 py-0.5 text-right text-xs text-slate-400 cursor-not-allowed"></div>`;
    }).join('');
    
    let extraInputs = '';
    if (sel.id == 10 || sel.id == '10B') {
        const pMode = sel.fullSpec.extra.pricingMode;
        const updateFn = `updateExtra('${sel.id}', 'pricingMode', this.value === 'black' ? 'black' : 'green')`; 
        extraInputs = `<div class="mt-2 p-2 bg-slate-800/50 rounded border border-indigo-500/30"><div class="text-[10px] text-indigo-300 font-semibold mb-1 uppercase">Pricing Mode</div><div class="flex gap-2"><label class="flex items-center gap-1 text-[10px] text-slate-400 cursor-not-allowed"><input type="radio" name="pr_price_${sel.id}" value="black" ${pMode === 'black' ? 'checked' : ''} disabled> Black->Purple</label><label class="flex items-center gap-1 text-[10px] text-slate-400 cursor-not-allowed"><input type="radio" name="pr_price_${sel.id}" value="green" ${pMode === 'green' ? 'checked' : ''} disabled> Green->Purple</label></div></div>`;
    }

    const strategyImage = BMP_IMAGES[sel.id] ? `<div class="mb-3 print-image-container"><img src="${BMP_IMAGES[sel.id]}" alt="${sel.name}" class="max-w-full h-auto rounded border border-slate-600 shadow-sm" style="max-width: 300px; max-height: 300px;" onerror="this.style.display='none'"></div>` : '';
    
    return `<div class="bg-gradient-to-br from-slate-800/40 to-slate-700/30 rounded-lg border border-slate-600 overflow-hidden shadow-sm hover:shadow-md transition-shadow"><div class="p-3 bg-gradient-to-r from-slate-800 to-slate-700/80"><div><div class="text-sm font-semibold text-white"><span class="image-tooltip-container">${sel.name}${BMP_IMAGES[sel.id] ? `<span class="image-tooltip"><img src="${BMP_IMAGES[sel.id]}" alt="${sel.name}" onerror="this.parentElement.parentElement.style.display='none'"></span>` : ''}</span></div><div class="text-[10px] text-slate-300 font-medium">Area: <span class="text-slate-100">${Math.round(sel.grossDesignedArea).toLocaleString()} sf</span> | Cost: <span class="text-emerald-300 font-semibold">$${Math.round(sel.costDesigned).toLocaleString()}</span></div></div></div><details class="group"><summary class="flex justify-between items-center p-2 cursor-pointer bg-slate-800/50 hover:bg-slate-700/50 transition-colors text-xs font-normal text-indigo-300 select-none"><span>Advanced Specs & Pricing</span><span class="transition group-open:rotate-180">\u25BC</span></summary><div class="p-3 bg-slate-900/30 border-t border-slate-700/50">${strategyImage}<div class="flex justify-between items-center mb-2"><label class="text-[10px] text-slate-400">Unit Cost ($/sf)</label><input type="number" value="${sel.unitPrice}" readonly disabled class="w-16 bg-slate-700/50 border border-slate-600 rounded px-2 py-0.5 text-right text-xs text-slate-400 cursor-not-allowed"></div>${specRows}${extraInputs}${sel.grossAreaNeeded > sel.eligibleArea ? `<div class="mt-2 text-[10px] text-red-400 bg-red-900/20 p-1 rounded border border-red-500/20">Area Deficit: -${Math.round(sel.grossAreaNeeded - sel.eligibleArea).toLocaleString()} sf</div>` : ''}</div></details></div>`;
  }).join('');
  
  html += `</div></div>`;
  panel.innerHTML = html;
}

let databaseEditingEnabled = false;

function toggleDatabaseEditing(enabled) {
  databaseEditingEnabled = enabled;
  const inputs = document.querySelectorAll('#database-modal-content input[type="number"]');
  inputs.forEach(input => {
    input.disabled = !enabled;
    if (enabled) {
      input.classList.remove('bg-slate-100', 'cursor-not-allowed');
      input.classList.add('bg-white');
    } else {
      input.classList.add('bg-slate-100', 'cursor-not-allowed');
      input.classList.remove('bg-white');
    }
  });
  const note = document.getElementById('database-edit-note');
  if (note) {
    note.textContent = enabled 
      ? 'Editing enabled. Changes apply immediately.' 
      : 'View-only mode. Check "Enable Editing" above to modify values. Changes apply immediately.';
    note.className = enabled 
      ? 'text-sm text-amber-600 mb-4 font-medium' 
      : 'text-sm text-slate-500 mb-4 italic';
  }
  // Show/hide Add Regulation button based on editing state
  const addBtn = document.getElementById('add-regulation-btn');
  if (addBtn) {
    if (enabled) {
      addBtn.classList.remove('hidden');
    } else {
      addBtn.classList.add('hidden');
    }
  }
  // Show/hide Save as Default button based on editing state
  const saveBtn = document.getElementById('save-defaults-btn');
  if (saveBtn) {
    if (enabled) {
      saveBtn.classList.remove('hidden');
    } else {
      saveBtn.classList.add('hidden');
    }
  }
  const checkbox = document.getElementById('enable-editing-checkbox');
  if (checkbox) checkbox.checked = enabled;
}

function openDatabaseModal() {
  const modal = document.getElementById('database-modal');
  const content = document.getElementById('database-modal-content');
  const i = state.inputs;
  databaseEditingEnabled = false; // Reset to disabled when opening
  
  content.innerHTML = `
    <div class="space-y-6">
      <!-- Regulation Basis Section -->
      <div class="border-b border-slate-200 pb-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="font-semibold text-slate-700 text-base">Regulation Basis Profiles</h3>
          <button id="add-regulation-btn" onclick="addNewRegulation()" class="hidden text-xs px-3 py-1.5 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition-colors font-medium" title="Add new city regulation profile">+ Add Regulation</button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          ${Object.values(REGULATION_PROFILES).map(profile => `
            <div class="p-4 bg-slate-50 rounded-lg border border-slate-200">
              <div class="font-semibold text-slate-700 mb-3 text-sm">${profile.label}</div>
              <div class="text-sm space-y-2 text-slate-600">
                <div class="flex justify-between"><span>Soil Retention:</span><strong class="text-indigo-600">${(profile.defaults.soilRetentionPct * 100).toFixed(0)}%</strong></div>
                <div class="flex justify-between"><span>NMW Retention:</span><strong class="text-indigo-600">${(profile.defaults.nmwRetentionPct * 100).toFixed(0)}%</strong></div>
                <div class="flex justify-between"><span>Honeycomb Void:</span><strong class="text-indigo-600">${(profile.defaults.honeycombVoidPct * 100).toFixed(0)}%</strong></div>
                ${profile.rules.nmwRetentionRequiresMinSoilCoverIn > 0 ? `<div class="text-xs text-amber-600 mt-2 pt-2 border-t border-slate-200">Note: NMW credit requires ‚â•${profile.rules.nmwRetentionRequiresMinSoilCoverIn}" soil cover</div>` : ''}
              </div>
            </div>
          `).join('')}
        </div>
      </div>
      
      <!-- BMP Database Table -->
      <div>
        <h3 class="font-semibold text-slate-700 mb-4 text-base">BMP Database</h3>
        <div class="text-sm text-slate-500 mb-4 italic" id="database-edit-note">View-only mode. Check "Enable Editing" above to modify values. Changes apply immediately.</div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          ${BMP_OPTIONS.map(bmp => {
            const spec = getSpec(bmp.id);
            const specRows = Object.entries(spec.specs).map(([key, val]) => {
              let unit = ''; const k = key.toLowerCase();
              if (k.includes('depth') || k.includes('freeboard')) unit = 'in'; 
              else if (k.includes('porosity') || k.includes('ratio') || k.includes('pct') || k.includes('loss')) unit = '%';
              return `<div class="flex justify-between text-sm py-1 border-b border-slate-100"><span class="text-slate-600">${key.replace(/([A-Z])/g, ' $1')}:</span><span class="font-mono text-slate-800">${val}${unit ? ' ' + unit : ''}</span></div>`;
            }).join('');
            return `
              <div class="border border-slate-200 rounded-lg p-4 bg-white shadow-sm">
                <div class="flex justify-between items-start mb-3">
                  <div class="flex-1">
                    <div class="font-semibold text-slate-700 text-base mb-1">${bmp.id}. ${bmp.name}</div>
                    <div class="text-xs text-slate-500">Area Type: <span class="font-mono">${bmp.areaType}</span></div>
                  </div>
                  <div class="ml-4">
                    <div class="text-xs text-slate-500 mb-1">Unit Price ($/sf)</div>
                    <div class="flex items-center gap-1">
                      <span class="text-slate-400">$</span>
                      <input type="number" value="${spec.unitPrice}" onchange="updatePrice('${bmp.id}', this.value)" disabled class="w-24 px-2 py-1.5 border border-slate-300 rounded text-sm bg-slate-100 cursor-not-allowed focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 database-input">
                    </div>
                  </div>
                </div>
                <details class="mt-2">
                  <summary class="text-sm text-indigo-600 cursor-pointer hover:text-indigo-700 font-medium">View/Edit Specs</summary>
                  <div class="mt-3 p-3 bg-slate-50 rounded border border-slate-200">
                    ${specRows}
                    ${bmp.extra ? `<div class="mt-3 pt-3 border-t border-slate-200">
                      <div class="text-xs text-slate-500 mb-1 font-semibold">Pricing Mode:</div>
                      <div class="text-sm">Base: <strong>$${bmp.extra.pricingBase}/sf</strong> | Upgrade: <strong>$${bmp.extra.pricingUpgrade}/sf</strong></div>
                    </div>` : ''}
                  </div>
                </details>
              </div>
            `;
          }).join('')}
        </div>
      </div>
      
      <div class="border-t border-slate-200 pt-4">
      </div>
    </div>
  `;
  
  // Set initial editing state
  const checkbox = document.getElementById('enable-editing-checkbox');
  if (checkbox) checkbox.checked = false;
  toggleDatabaseEditing(false);
  
  modal.classList.remove('hidden');
  document.body.style.overflow = 'hidden';
}

function closeDatabaseModal() {
  const modal = document.getElementById('database-modal');
  modal.classList.add('hidden');
  document.body.style.overflow = '';
  databaseEditingEnabled = false; // Reset when closing
}

function process() {
  const data = runCalculations();
  renderSidebar();
  renderDashboard(data);
  updateLayout();
  saveStateToUrl(); // Auto-save state to URL hash on every change
}

// Position image tooltips dynamically on hover - center them in viewport
let tooltipSetupDone = false;
function setupImageTooltips() {
  if (tooltipSetupDone) return; // Only setup once
  tooltipSetupDone = true;
  
  // Use event delegation for dynamically created elements
  document.addEventListener('mouseenter', function(e) {
    const container = e.target.closest('.image-tooltip-container');
    if (!container) return;
    
    const tooltip = container.querySelector('.image-tooltip');
    if (!tooltip) return;
    
    const img = tooltip.querySelector('img');
    if (!img) return;
    
    // Temporarily show tooltip to get its dimensions
    tooltip.style.visibility = 'visible';
    tooltip.style.opacity = '0';
    tooltip.style.left = '0';
    tooltip.style.top = '0';
    tooltip.style.display = 'block';
    
    // Wait for image to load and measure
    const positionTooltip = () => {
      // Force a reflow to get accurate dimensions
      void tooltip.offsetWidth;
      
      const tooltipRect = tooltip.getBoundingClientRect();
      const viewportWidth = window.innerWidth;
      const viewportHeight = window.innerHeight;
      
      // Center horizontally and vertically in viewport
      let left = (viewportWidth - tooltipRect.width) / 2;
      let top = (viewportHeight - tooltipRect.height) / 2;
      
      // Ensure tooltip stays within viewport bounds with padding
      const padding = 20;
      left = Math.max(padding, Math.min(left, viewportWidth - tooltipRect.width - padding));
      top = Math.max(padding, Math.min(top, viewportHeight - tooltipRect.height - padding));
      
      tooltip.style.left = left + 'px';
      tooltip.style.top = top + 'px';
      tooltip.style.transform = 'none';
      
      // Now show it
      setTimeout(() => {
        tooltip.style.opacity = '1';
        tooltip.classList.add('show');
      }, 10);
    };
    
    if (img && !img.complete) {
      img.onload = positionTooltip;
      img.onerror = () => { 
        tooltip.style.visibility = 'hidden';
        tooltip.style.display = 'none';
      };
    } else {
      positionTooltip();
    }
  }, true);
  
  document.addEventListener('mouseleave', function(e) {
    const container = e.target.closest('.image-tooltip-container');
    if (!container) return;
    
    const tooltip = container.querySelector('.image-tooltip');
    if (!tooltip) return;
    
    tooltip.style.visibility = 'hidden';
    tooltip.style.opacity = '0';
    tooltip.style.display = 'none';
    tooltip.classList.remove('show');
  }, true);
}

window.onload = () => { 
  loadSavedDefaults(); // Load saved defaults first
  loadStateFromUrl(); // Then load URL state (which may override saved defaults)
  renderSidebar(); 
  process();
  setupImageTooltips();
};
</script>
</body>
</html>
